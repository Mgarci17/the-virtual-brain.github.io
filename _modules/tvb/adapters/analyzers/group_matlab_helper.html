

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.adapters.analyzers.group_matlab_helper &mdash; The Virtual Brain 1.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Virtual Brain 1.0.4 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.adapters.analyzers.group_matlab_helper</h1><pre>
# -*- coding: utf-8 -*-
#
#
# TheVirtualBrain-Framework Package. This package holds all Data Management, and 
# Web-UI helpful to run brain-simulations. To use it, you also need do download
# TheVirtualBrain-Scientific Package (for simulators). See content of the
# documentation-folder for more details. See also http://www.thevirtualbrain.org
#
# (c) 2012-2013, Baycrest Centre for Geriatric Care ("Baycrest")
#
# This program is free software; you can redistribute it and/or modify it under 
# the terms of the GNU General Public License version 2 as published by the Free
# Software Foundation. This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
# License for more details. You should have received a copy of the GNU General 
# Public License along with this program; if not, you can download it here
# http://www.gnu.org/licenses/old-licenses/gpl-2.0
#
#

"""
This module implements a class for executing arbitray MATLAB code

Conversion between Python types and MATLAB types is handled and dependent
on scipy.io's loadmat and savemat function.

.. moduleauthor:: Marmaduke Woodman &lt;Marmaduke@tvb.invalid&gt;
.. moduleauthor:: Stuart A. Knock &lt;Stuart@tvb.invalid&gt;
"""

import os, time, random, tempfile
from scipy.io import loadmat, savemat
from tvb.basic.config.settings import TVBSettings as cfg
from tvb.core.utils import MATLAB, OCTAVE, matlab_cmd
from tvb.core.adapters.abcadapter import ABCAsynchronous


<div class="viewcode-block" id="MatlabAnalyzer"><a class="viewcode-back" href="../../../../tvb.adapters.analyzers.html#tvb.adapters.analyzers.group_matlab_helper.MatlabAnalyzer">[docs]</a>class MatlabAnalyzer(ABCAsynchronous):
    """
    MatlabAnalyzer is an adapter for calling arbitrary MATLAB code with
    arbitrary data.

    Specific analyzers should derive from this class and implement the
    interface and launch methods inherited from Asynchronous Adapter.
    """

    matlab_paths = []

    def __init__(self):
        ABCAsynchronous.__init__(self)
        self.mlab_exe = cfg.MATLAB_EXECUTABLE
        self.hex = hex(random.randint(0, 2**32))
        self.script_name = "script%s" % self.hex
        self.script_fname = self.script_name + '.m'
        self.wkspc_name = "wkspc%s" % self.hex
        self.wkspc_fname = self.wkspc_name + '.mat'
        self.done_name = "done%s" % self.hex
        self.done_fname = self.done_name + '.mat'
        self.log_fname = "log%s" % self.hex

    def _matlab_pre(self):
        """
        Called to obtain the pre operation code for MATLAB. Current, we
        1. add paths to the MATLAB path
        2. enter a try clause
        """
        paths = "".join(["addpath('"+p+"');\n" for p in self.matlab_paths])
        return paths + "\ntry\n"

    def _matlab_post(self):
        """
        Called to obtain the post operation code for MATLAB. Currently, we
        1. catch exception if one was raised
        2. set the hexstamp variable in MATLAB
        3. save all working files
        """
        catch = "\ncatch e\nexception%s = e\nend\n" % self.hex
        if MATLAB in self.mlab_exe:
            save_clause = "hexstamp = '%s'\nsave %s -V7\nsave %s -V7 hexstamp\nquit"
        if OCTAVE in self.mlab_exe:
            save_clause = "hexstamp = '%s'\nsave %s.mat -V7\nsave %s.mat -V7 hexstamp\nquit"
        return catch + save_clause % (self.hex, self.wkspc_name, self.done_name)

<div class="viewcode-block" id="MatlabAnalyzer.launch"><a class="viewcode-back" href="../../../../tvb.adapters.analyzers.html#tvb.adapters.analyzers.group_matlab_helper.MatlabAnalyzer.launch">[docs]</a>    def launch(self, code, data=None, wd=None, cleanup=True):
        """
        Analyzers that derive from this adapter and use MATLAB should
        override this method.
        """
        return self.matlab(code, data, cleanup)
</div>
<div class="viewcode-block" id="MatlabAnalyzer.cleanup"><a class="viewcode-back" href="../../../../tvb.adapters.analyzers.html#tvb.adapters.analyzers.group_matlab_helper.MatlabAnalyzer.cleanup">[docs]</a>    def cleanup(self):
        """
        Make sure Matlab is closed after execution.
        """
        time.sleep(0.5) # wait for MATLAB to close
        for file_ref in [self.script_fname, self.wkspc_fname,
                         self.done_fname, self.log_fname]:
            try:
                os.remove(file_ref)
            except Exception, _:
                pass
</div>
<div class="viewcode-block" id="MatlabAnalyzer.add_to_path"><a class="viewcode-back" href="../../../../tvb.adapters.analyzers.html#tvb.adapters.analyzers.group_matlab_helper.MatlabAnalyzer.add_to_path">[docs]</a>    def add_to_path(self, path_to_add):
        """
        Add a path to the list of paths that will be added to the path
        in the MATLAB session
        """
        self.matlab_paths.append(path_to_add)
</div>
<div class="viewcode-block" id="MatlabAnalyzer.matlab"><a class="viewcode-back" href="../../../../tvb.adapters.analyzers.html#tvb.adapters.analyzers.group_matlab_helper.MatlabAnalyzer.matlab">[docs]</a>    def matlab(self, code, data=None, work_dir=None, cleanup=True):
        """
        method matlab takes as arguments:

            code: MATLAB code in a string
            data: a dict of data that scipy.io.savemat knows how to deal with
            work_dir: working directory to be used by MATLAB
            cleanup: set to False to keep files

        and returns a tuple:

            [0] string of code exec'd by MATLAB
            [1] string of log produced by MATLAB
            [2] dict of data from MATLAB's workspace
        """
        wdir = tempfile.tempdir or os.getcwd()
        os.chdir(wdir)
        os.chdir(work_dir or os.getcwd())

        pre, post = self._matlab_pre(), self._matlab_post()
        code = ("\nsuccess%s = 0\n" + code + "\nsuccess%s = 1\n") % (self.hex, self.hex)

        if data:
            pre += "\nload %s\n" % self.wkspc_name
            savemat(self.wkspc_fname, data, format="5")
        with open(self.script_fname,'w') as file_data:
            file_data.write(pre + code + post)

        os.system(matlab_cmd(self.mlab_exe, self.script_name, self.log_fname))
        while not os.path.exists(self.done_fname):
            time.sleep(0.1)

        with open(self.log_fname, 'r') as file_data:
            logtext = file_data.read()
        retdata = loadmat(self.wkspc_fname, squeeze_me=True)

        if cleanup: self.cleanup()
        return pre + code + post, logtext, retdata
</div>
    @classmethod
<div class="viewcode-block" id="MatlabAnalyzer.scrape_mfile"><a class="viewcode-back" href="../../../../tvb.adapters.analyzers.html#tvb.adapters.analyzers.group_matlab_helper.MatlabAnalyzer.scrape_mfile">[docs]</a>    def scrape_mfile(filename):
        """
        MatlabAnalyzer.scrape_mfile takes an absolute filename (i.e. 
        no expansion is done), analyzes the file and returns a dictionary
        of information about the corresponding MATLAB function: 

            ret{'docs' : docstring of the MATLAB function 

                'args' : list of argument names to the MATLAB function or 
                         None if the function takes no arguments

                'rets' : list of function's results' names or None if the 
                         function produces no results
        """

        # helper functions to clean strings
        re_keep = lambda m, r: m.group()[:re.match(r, m.group()).end()]
        re_del = lambda m, r: m.group()[re.match(r, m.group()).end():]

        with open(filename) as fd:
            src = fd.read()
        
        # grab the docstring first
        docs = re.search('(^%.*\n)+', src, re.MULTILINE).group()

        # grab the function signature
        sig = re.match('.*function.*', src)

        # if we don't have one return None
        if not sig:
            return None

        # get the text
        sig = sig.group()

        # remove 'function' from string
        fn = re.match('\s*function\s*', src)
        sig1 = sig[fn.end():]

        # get outputs, either 'A=foo' or '[A,B] = foo'
        lhs = re.match('\w+\s*=|\[.+\]\s*=', sig1)
        outs = re_keep(lhs, '\w+|\[.+\]')[1:-1].split() if lhs else None
        sig2 = sig1[lhs.end():]

        # get function name
        rhs = re.match('\s*\w+', sig2)
        fname = re_del(rhs, '\s*')
        sig3 = sig2[rhs.end():]

        # get arguments if they exist
        rhs = re.match('.*\(.+\)', sig3)
        ins = rhs.group()[1:-1].split(',') if rhs else None

        return {'args': ins, 'rets': outs, 'docs': docs}



   </div></div>
</pre>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>