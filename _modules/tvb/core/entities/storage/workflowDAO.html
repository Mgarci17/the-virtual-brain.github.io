

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.core.entities.storage.workflowDAO &mdash; The Virtual Brain 1.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '1.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Virtual Brain 1.0.4 documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.core.entities.storage.workflowDAO</h1><pre>
# -*- coding: utf-8 -*-
#
#
# TheVirtualBrain-Framework Package. This package holds all Data Management, and 
# Web-UI helpful to run brain-simulations. To use it, you also need do download
# TheVirtualBrain-Scientific Package (for simulators). See content of the
# documentation-folder for more details. See also http://www.thevirtualbrain.org
#
# (c) 2012-2013, Baycrest Centre for Geriatric Care ("Baycrest")
#
# This program is free software; you can redistribute it and/or modify it under 
# the terms of the GNU General Public License version 2 as published by the Free
# Software Foundation. This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
# License for more details. You should have received a copy of the GNU General 
# Public License along with this program; if not, you can download it here
# http://www.gnu.org/licenses/old-licenses/gpl-2.0
#
#

"""
DAO layer for WorkFlow and Burst entities.
"""
from tvb.core.entities import model
from tvb.core.entities.storage.rootDAO import RootDAO
from sqlalchemy import func as func
from sqlalchemy.orm.exc import NoResultFound
from sqlalchemy.sql.expression import desc, not_

    
<div class="viewcode-block" id="WorkflowDAO"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO">[docs]</a>class WorkflowDAO(RootDAO):
    """
    DAO layer for WorkFlow and Burst entities.
    """
        
        
<div class="viewcode-block" id="WorkflowDAO.get_non_validated_entities"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_non_validated_entities">[docs]</a>    def get_non_validated_entities(self, reference_time):
        """
        Get a list of all categories, portlets and algorithm groups that were not found valid since the reference_time.
        Used in initializer on each start to filter out any entities that for some reason became invalid.
        """
        all_invalid_entities = []
        try:
            algo_groups = self.session.query(model.AlgorithmGroup
                                        ).filter(model.AlgorithmGroup.last_introspection_check &lt; reference_time).all()
            categories = self.session.query(model.AlgorithmCategory
                                        ).filter(model.AlgorithmCategory.last_introspection_check&lt;reference_time).all()
            portlets = self.session.query(model.Portlet
                                        ).filter(model.Portlet.last_introspection_check &lt; reference_time).all()
            all_invalid_entities = algo_groups + categories + portlets
        except Exception, ex:
            self.logger.error(ex)
            all_invalid_entities = []
        return all_invalid_entities
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_bursts_for_project"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_bursts_for_project">[docs]</a>    def get_bursts_for_project(self, project_id, page_start=0, page_end=None, count=False):
        """Get latest 50 BurstConfiguration entities for the current project"""
        try:
            bursts = self.session.query(model.BurstConfiguration
                                   ).filter_by(fk_project=project_id
                                   ).order_by(desc(model.BurstConfiguration.id))
            if count == True:
                return bursts.count()
            if page_end is not None:
                bursts = bursts.offset(max(page_start, 0)).limit(page_end)
            
            bursts = bursts.all()
        except Exception, excep:
            self.logger.exception(excep)
            bursts = None
        return bursts
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_max_burst_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_max_burst_id">[docs]</a>    def get_max_burst_id(self,):
        """
        Return the maximum of the currently stored burst ids to be used as the new burst name.
        """
        max_id = 1
        try:
            max_id = self.session.query(func.max(model.BurstConfiguration.id)).one()
        except Exception, excep:
            self.logger.exception(excep)
            max_id = 1
        if max_id[0] is None:
            return 1
        return max_id[0] + 1
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.count_bursts_with_name"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.count_bursts_with_name">[docs]</a>    def count_bursts_with_name(self, burst_name, project_id):
        """
        Return the number of burst already named 'custom_b%' and NOT 'custom_b%_%' in current project.
        """
        count = 0
        try:
            count = self.session.query(model.BurstConfiguration
                                       ).filter_by(fk_project=project_id
                                       ).filter(model.BurstConfiguration.name.like(burst_name + '%')
                                       ).filter(not_(model.BurstConfiguration.name.like(burst_name + '/_%/_%', 
                                                                                        escape='/'))
                                       ).count()
        except Exception, excep:
            self.logger.exception(excep)
        return count
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_burst_by_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_burst_by_id">[docs]</a>    def get_burst_by_id(self, burst_id):
        """Get the BurstConfiguration entity with the given id"""
        try:
            burst = self.session.query(model.BurstConfiguration).filter_by(id=burst_id).one()
        except Exception, excep:
            self.logger.exception(excep)
            burst = None
        return burst
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_visualization_steps"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_visualization_steps">[docs]</a>    def get_visualization_steps(self, workflow_id):
        """Retrieve all the visualization steps for a workflow."""
        try:
            result = self.session.query(model.WorkflowStepView
                                        ).filter(model.WorkflowStepView.fk_workflow == workflow_id
                                        ).order_by(model.WorkflowStepView.tab_index, 
                                                   model.WorkflowStepView.index_in_tab).all()
            return result
        except Exception, excep:
            self.logger.exception(excep)
            return None
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_workflow_steps"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_workflow_steps">[docs]</a>    def get_workflow_steps(self, workflow_id):
        """Retrieve all the simulation/analyzers steps for a workflow."""
        try:
            # Also check that index is non-negative to preserve backwards
            # compatibility to versions &lt; 1.0.2.
            result = self.session.query(model.WorkflowStep
                                        ).filter(model.WorkflowStep.fk_workflow == workflow_id
                                        ).filter(model.WorkflowStep.step_index &gt; -1
                                        ).order_by(model.WorkflowStep.step_index).all()
            return result
        except Exception, excep:
            self.logger.exception(excep)
            return None
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_workflows_for_burst"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_workflows_for_burst">[docs]</a>    def get_workflows_for_burst(self, burst_id):
        """Returns all the workflows that were launched for this burst id"""
        workflows = []
        try:
            workflows = self.session.query(model.Workflow).filter_by(fk_burst=burst_id).all()
        except Exception, excep:
            self.logger.exception(excep)
            workflows = []
        return workflows
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_workflow_by_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_workflow_by_id">[docs]</a>    def get_workflow_by_id(self, workflow_id):
        """"Returns the workflow instance with the given id"""
        workflow = None
        try:
            workflow = self.session.query(model.Workflow).filter_by(id=workflow_id).one()
        except Exception, excep:
            self.logger.exception(excep)
            workflow = None
        return workflow
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_workflow_step_by_step_index"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_workflow_step_by_step_index">[docs]</a>    def get_workflow_step_by_step_index(self, workflow_id, step_index):
        """
        :return WorkflowStep entity of None.
        """
        step = None
        try:
            step = self.session.query(model.WorkflowStep).filter_by(fk_workflow=workflow_id, 
                                                                    step_index=step_index).one()
        except NoResultFound, excep:
            self.logger.debug(str("No step found for workflow_id=%s and step_index=%s")%(workflow_id, step_index))
            step = None
        except Exception, excep:
            self.logger.exception(excep)
            step = None
        return step
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_workflow_steps_for_position"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_workflow_steps_for_position">[docs]</a>    def get_workflow_steps_for_position(self, workflow_id, tab_index, index_in_tab):
        """
        Retrieve a list of analyzers corresponding to current cell in the portlets grid.
        Will be used for deciding the interface.
        """
        steps = []
        try:
            steps = self.session.query(model.WorkflowStep
                                       ).filter_by(fk_workflow=workflow_id, 
                                                   tab_index=tab_index, index_in_tab=index_in_tab
                                       ).order_by(model.WorkflowStep.step_index).all()
        except Exception, excep:
            self.logger.exception(excep)
            
        return steps
           
            </div>
<div class="viewcode-block" id="WorkflowDAO.get_configured_portlets_for_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_configured_portlets_for_id">[docs]</a>    def get_configured_portlets_for_id(self, portlet_id):
        """
        Get the workflow steps that were generated from the portlet given by portlet_id.
        """
        wf_steps = []
        try:
            wf_steps = self.session.query(model.WorkflowStepView).filter_by(fk_portlet=portlet_id).all()
        except Exception, excep:
            self.logger.exception(excep)
            wf_steps = []
        return wf_steps
            
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_workflow_step_for_operation"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_workflow_step_for_operation">[docs]</a>    def get_workflow_step_for_operation(self, operation_id):
        """
        Returns the executed workflow step from which resulted
        the operation with the given id 'operation_id'.
        Returns None if there is no such executed workflow step.
        """
        step = None
        try:
            step = self.session.query(model.WorkflowStep).filter_by(fk_operation=operation_id).one()
        except NoResultFound, excep:
            self.logger.debug(str("No step found for operation_id=%s")%(operation_id))
            step = None
        except Exception, excep:
            self.logger.exception(excep)
            step = None
        return step
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_available_portlets"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_available_portlets">[docs]</a>    def get_available_portlets(self,):
        """
        Get all the stored portlets form the db.
        """
        portlets = []
        try:
            portlets = self.session.query(model.Portlet).order_by(model.Portlet.name).all()
        except Exception, excep:
            self.logger.exception(excep)
            portlets = []
        return portlets
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_portlet_by_identifier"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_portlet_by_identifier">[docs]</a>    def get_portlet_by_identifier(self, portlet_identifier):
        """
        Given an identifer retieve the portlet that corresponds to it.
        """
        portlet = None
        try:
            portlet = self.session.query(model.Portlet).filter_by(algorithm_identifier=portlet_identifier).one()
        except NoResultFound, excep:
            self.logger.debug(str("No portlet found with id=%s.")%(portlet_identifier,))
            portlet = None
        except Exception, excep:
            self.logger.exception(excep)
            portlet = None
        return portlet
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_portlet_by_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_portlet_by_id">[docs]</a>    def get_portlet_by_id(self, portlet_id):
        """
        Given an portlet id retieve the portlet entity.
        """
        portlet = None
        try:
            portlet = self.session.query(model.Portlet).filter_by(id=portlet_id).one()
        except Exception, excep:
            self.logger.exception(excep)
            portlet = None
        return portlet
    
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_workflow_for_operation_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_workflow_for_operation_id">[docs]</a>    def get_workflow_for_operation_id(self, operation_id):
        """
        Get the workflow from which operation_id was generated.
        """
        workflow = None
        try:
            workflow = self.session.query(model.Workflow).join(model.WorkflowStep
                                    ).filter(model.WorkflowStep.fk_operation==operation_id).one()
        except NoResultFound, _:
            self.logger.warning("Operation with id=%s was not generated from any workflow."%(operation_id,))
        except Exception, excep:
            self.logger.error(excep)
        return workflow
        
    </div>
<div class="viewcode-block" id="WorkflowDAO.get_burst_for_operation_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_burst_for_operation_id">[docs]</a>    def get_burst_for_operation_id(self, operation_id):
        """
        Get the burst for which this operation was created.
        """
        burst = None
        try:
            burst = self.session.query(model.BurstConfiguration
                                       ).join(model.Workflow, model.Workflow.fk_burst==model.BurstConfiguration.id
                                       ).join(model.WorkflowStep
                                       ).filter(model.WorkflowStep.fk_operation==operation_id).one()
        except NoResultFound, _:
            self.logger.debug("No burst found for operation id = %s"%(operation_id,))
        except Exception, excep:
            self.logger.error(excep)
        return burst
      
      </div>
<div class="viewcode-block" id="WorkflowDAO.get_all_datatypes_in_burst"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.workflowDAO.WorkflowDAO.get_all_datatypes_in_burst">[docs]</a>    def get_all_datatypes_in_burst(self, burst_id):
        """
        Get all dataTypes in burst
        
        :param burst_id BurstConfiguration Identifier.
        :return list dataType GIDs or empty list.
        """
        try:
            result = self.session.query(model.DataTypeGroup,
                           ).join(model.Operation, model.DataTypeGroup.fk_from_operation==model.Operation.id
                           ).join(model.WorkflowStep, model.Operation.id==model.WorkflowStep.fk_operation
                           ).join(model.Workflow).filter(model.Workflow.fk_burst==burst_id).all()
            datatypes = self.session.query(model.DataType
                                      ).filter(model.DataType.fk_parent_burst==burst_id
                                      ).filter(model.DataType.fk_datatype_group==None
                                      ).filter(model.DataType.type!=self.EXCEPTION_DATATYPE_GROUP).all()
            result.extend(datatypes)
        except Exception, exc:
            self.logger.debug(exc)
            result = []
        return result
</div></div>
</pre>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>