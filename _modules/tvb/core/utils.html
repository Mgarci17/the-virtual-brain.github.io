

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.core.utils &mdash; The Virtual Brain 1.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Virtual Brain 1.0.4 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.core.utils</h1><pre>
# -*- coding: utf-8 -*-
#
#
# TheVirtualBrain-Framework Package. This package holds all Data Management, and 
# Web-UI helpful to run brain-simulations. To use it, you also need do download
# TheVirtualBrain-Scientific Package (for simulators). See content of the
# documentation-folder for more details. See also http://www.thevirtualbrain.org
#
# (c) 2012-2013, Baycrest Centre for Geriatric Care ("Baycrest")
#
# This program is free software; you can redistribute it and/or modify it under 
# the terms of the GNU General Public License version 2 as published by the Free
# Software Foundation. This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
# License for more details. You should have received a copy of the GNU General 
# Public License along with this program; if not, you can download it here
# http://www.gnu.org/licenses/old-licenses/gpl-2.0
#
#

"""
.. moduleauthor:: Lia Domide &lt;lia.domide@codemart.ro&gt;
"""

import os
import csv
import sys
import json
import datetime
import uuid
import numpy
import signal
from scipy import io as scipy_io
from tvb.basic.config.settings import TVBSettings as configFile
from tvb.basic.logger.builder import get_logger

LOGGER = get_logger(__name__)

MATLAB = "matlab"
OCTAVE = "octave"
 
CHAR_SEPARATOR = "__"
CHAR_SPACE = "--"
CHAR_DRIVE = "-DriVe-"
DRIVE_SEP = ":"
COMPLEX_TIME_FORMAT = '%Y-%m-%d,%H-%M-%S.%f'
# LESS_COMPLEX_TIME_FORMAT is also compatible with data exported from TVB 1.0. 
# This is only used as a fallback in the string to date conversion.
LESS_COMPLEX_TIME_FORMAT = '%Y-%m-%d,%H-%M-%S'
SIMPLE_TIME_FORMAT = "%m-%d-%Y"
 
   
################## PATH related methods start here ###############
   
<div class="viewcode-block" id="path2url_part"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.path2url_part">[docs]</a>def path2url_part(file_path):
    """
    Prepare a File System Path for passing into an URL.
    """
    if not os.path.isabs(file_path):
        file_path = os.path.join(configFile.TVB_STORAGE, file_path)
    return file_path.replace(os.sep, CHAR_SEPARATOR).replace(" ", 
                            CHAR_SPACE).replace(DRIVE_SEP, CHAR_DRIVE)
    
    </div>
<div class="viewcode-block" id="url2path"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.url2path">[docs]</a>def url2path(encoded_path):
    """
    Retrieve File System Path from encoded URL (inverse of path2url_part).
    """
    return encoded_path.replace(CHAR_SEPARATOR, os.sep).replace(CHAR_SPACE, 
                                " ").replace(CHAR_DRIVE, DRIVE_SEP)

</div>
<div class="viewcode-block" id="get_unique_file_name"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.get_unique_file_name">[docs]</a>def get_unique_file_name(storage_folder, file_name, try_number=0):   
    """
    Compute non-existent file name, in storage_folder.
    Try file_name, and if already exists, try adding a number.
    """
    #TODO this method should be re-tought
    name, ext = os.path.splitext(file_name)
    date = str(datetime.datetime.now())
    date = date.replace(' ', '').replace(':', '').replace('.', '').replace('-', '')
    if try_number &gt; 0:
        file_ = '%s-%s%s' % (name, date, ext)
    else:
        file_ = file_name
    full_path = os.path.join(storage_folder, file_)
    if os.path.exists(full_path):
        #Try another name, by appending the consecutive try_number
        return get_unique_file_name(storage_folder, file_name, try_number + 1)
    return full_path, file_
 
 
################## PATH related methods end here ###############    
  
  
################## FILE related methods start here ###############
</div>
<div class="viewcode-block" id="read_matlab_data"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.read_matlab_data">[docs]</a>def read_matlab_data(path, matlab_data_name=None):
    """
    Read array from matlab file.
    """
    try:
        matlab_data = scipy_io.matlab.loadmat(path)
    except NotImplementedError, exc:
        LOGGER.error("Could not read Matlab content from: " + path)
        LOGGER.error("Matlab files must be saved in a format &lt;= -V7...")
        raise exc
    
    return matlab_data[matlab_data_name]

</div>
<div class="viewcode-block" id="store_list_data"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.store_list_data">[docs]</a>def store_list_data(data_list, file_name, storage_folder, overwrite=False):
    """
    Write a list into a file using CSV writer.
    CSV writer, better than numpy, write also Strings
    """
    if data_list is None or not (isinstance(data_list, list) or 
                                isinstance(data_list, numpy.ndarray)):
        raise Exception("Invalid given type!! " + str(type(data_list)))
    if overwrite:
        full_path = os.path.join(storage_folder, file_name)
        file_name = os.path.split(full_path)[1]
    else:
        full_path, file_name = get_unique_file_name(storage_folder, file_name)
    
    # generic writer, capable to write strings also
    destination = open(full_path, 'wb')
    csv_writer = csv.writer(destination, delimiter=' ')
    if (isinstance(data_list[0], list) or 
        isinstance(data_list[0], numpy.ndarray)):
        for row in data_list:
            csv_writer.writerow(row)
    else:
        csv_writer.writerow(data_list)

    return file_name
     

################## FILE related methods end here ###############  
   
    
################## CONVERT related methods start here ###############
</div>
<div class="viewcode-block" id="parse_json_parameters"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.parse_json_parameters">[docs]</a>def parse_json_parameters(parameters):
    """
    From JSON with Unicodes, return a dictionary having strings as keys.
    Loading from DB a JSON will return instead of string keys, unicodes.
    """
    params = json.loads(parameters)
    new_params = {}
    for key, value in params.iteritems():
        new_params[str(key)] = value
    return new_params

</div>
<div class="viewcode-block" id="string2date"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.string2date">[docs]</a>def string2date(string_input, complex_format=True, date_format=None):
    """Read date from string, after internal format"""
    if date_format is not None:
        return datetime.datetime.strptime(string_input, date_format)
    if complex_format:
        try:
            return datetime.datetime.strptime(string_input, COMPLEX_TIME_FORMAT)
        except ValueError:
            # For backwards compatibility with TVB 1.0
            return datetime.datetime.strptime(string_input, LESS_COMPLEX_TIME_FORMAT)
    return datetime.datetime.strptime(string_input, SIMPLE_TIME_FORMAT)       

</div>
<div class="viewcode-block" id="date2string"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.date2string">[docs]</a>def date2string(date_input, complex_format=True, date_format=None):
    """Convert date into string, after internal format"""
    if date_input is None:
        return "None"
    
    if date_format is not None:
        return date_input.strftime(date_format)
    
    if complex_format:
        return date_input.strftime(COMPLEX_TIME_FORMAT)
    return date_input.strftime(SIMPLE_TIME_FORMAT)

</div>
<div class="viewcode-block" id="timedelta2string"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.timedelta2string">[docs]</a>def timedelta2string(timedelta):
    """
    Convert a datetime.timedelta object into a nice string, to be displayed in UI.
    """
    if timedelta is None:
        return None
    result = str(timedelta)
    days = 0
    if 'days,' in result:
        result = result.split('days,')
        days = int(result[0])
        result = result[1].split(':')
    else:
        result = result.split(':')
    hours = int(result[0])
    minutes = int(result[1])
    seconds = int(float(result[2]))
    if days &gt; 0:
        return str(days) + "d " + str(hours) + "h"
    if hours &gt; 0:
        return str(hours) +"h " + str(minutes) +"m"
    if minutes &gt; 0:
        return str(minutes) +"m " + str(seconds) +"s"
    return str(seconds) + "s"
    
</div>
<div class="viewcode-block" id="string2bool"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.string2bool">[docs]</a>def string2bool(string_input):
    """ Convert given string into boolean value."""
    if string_input is not None: 
        if isinstance(string_input, unicode):
            string_input = str(string_input)
            
        if isinstance(string_input, str):
            return string_input.lower() in ("yes", "true", "t", "1")
    
    return False
</div>
<div class="viewcode-block" id="bool2string"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.bool2string">[docs]</a>def bool2string(bool_value):
    """ Convert boolean value to string """
    return str(bool_value)
    </div>
ARRAY_BEGIN = -1
DATA_UNCONVERTED = 1
DATA_CONVERTED = 2

<div class="viewcode-block" id="string2array"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.string2array">[docs]</a>def string2array(input_data_str, split_char, dtype=None):
    """
    Given an input string first try to load it using JSON and if that fails,
     meaning some weird array is given by the user, fall-back to _custom_string2array.
    """
    prepared_input_data_str = input_data_str.replace(split_char, ',')
    if not prepared_input_data_str.strip().startswith('['):
        # In case of range for a model parameter for example, the input string here is just a float
        # which will be converted to a 0-d numpy array instead of a 1-d array if brackets are missing.
        prepared_input_data_str = '[' + prepared_input_data_str.strip() + ']'
    try:
        array = json.loads(prepared_input_data_str)
        return numpy.array(array)
    except ValueError:
        logger = get_logger(__name__)
        logger.warning("Received input array %s is poorly formated and could not be evaluated by Python."
                       "Falling back to _custom_string2array."%(prepared_input_data_str))
        return _custom_string2array(input_data_str, split_char, dtype)
        
    </div>
def _custom_string2array(input_data_str, split_char, dtype=None):
    """
    From a long string, parse a NumPy array.
    """
    class HelperData():
        """Helper for parsing arrays"""
        def __init__(self, data, type_):
            self.data = data
            self.type = type_
                
    input_str = input_data_str.lstrip().rstrip()
    to_replace = split_char + split_char
    while to_replace in input_str:
        input_str = input_str.replace(to_replace, split_char)
    input_str = input_str.replace('[' + split_char, '[')
    input_str = input_str.replace(split_char + ']', ']')
    input_str = input_str.replace(' ' + split_char, split_char)
    input_str = input_str.replace(split_char + ' ', split_char)
    input_str = input_str.replace('[ ' , '[').replace(' ]', ']')
                
    str_pos = 0
    data_stack = []
    while str_pos &lt; len(input_str):
        if input_str[str_pos] == '[':
            data_stack.append(HelperData('[', -1))
        elif input_str[str_pos] == split_char:
            if data_stack[-1].type == DATA_UNCONVERTED:
                if dtype is not None:
                    elem_type = dtype + "('" + data_stack[-1].data + "')"
                    data_stack[-1].data = eval(elem_type)
                data_stack[-1].type = DATA_CONVERTED
        elif input_str[str_pos] == ']':
            new_array = []
            if data_stack[-1].type == DATA_UNCONVERTED:
                if dtype is not None:
                    elem_type = dtype + "('" + data_stack[-1].data + "')"
                    data_stack[-1].data = eval(elem_type)
                data_stack[-1].type = DATA_CONVERTED
            while data_stack[-1].type != ARRAY_BEGIN:
                last_data = data_stack.pop()
                new_array.insert(0, last_data.data)
            data_stack.pop()
            new_array = HelperData(new_array, 0)
            data_stack.append(new_array)
            
        elif (len(data_stack) == 0 or data_stack[-1].type != DATA_UNCONVERTED):
            data_stack.append(HelperData(input_str[str_pos], DATA_UNCONVERTED))
        else: 
            data_stack[-1].data = data_stack[-1].data + input_str[str_pos]
        str_pos += 1
    if len(data_stack) == 0:
        return None
    
    if type(data_stack[0].data) in (str, unicode):
        if dtype is not None:
            if data_stack[-1].data == 'None':
                return None
            elem_type = dtype + "('" + data_stack[-1].data + "')"
            data_stack[-1].data = eval(elem_type)
        return data_stack[0].data
    return numpy.array(data_stack[0].data)

     
################## CONVERT related methods end here ###############


################## MATLAB related method start here ###############

<div class="viewcode-block" id="get_matlab_executable"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.get_matlab_executable">[docs]</a>def get_matlab_executable():
    """
    Check If MATLAB is installed on current system.
    Return True or False.
    Return True, when MATLAB executable is found in Path.
    """
    matlab_exe_path = None
    if sys.platform.startswith('win'):
        split_char = ";"
        octave_exec = OCTAVE + ".exe"
        matlab_exec = MATLAB + ".exe"
    else:
        split_char = ":"
        octave_exec = OCTAVE
        matlab_exec = MATLAB
    logger = get_logger(__name__)
    logger.debug("Searching Matlab in path: " + str(os.environ["PATH"]))
    for path in os.environ["PATH"].split(split_char):
        if os.path.isfile(os.path.join(path, matlab_exec)):
            matlab_exe_path = os.path.join(path, matlab_exec)
            logger.debug("MATLAB was found:" + path)
            return matlab_exe_path
    for path in os.environ["PATH"].split(split_char):
        if os.path.isfile(os.path.join(path, octave_exec)):
            logger.debug("OCTAVE was found:" + path)
            matlab_exe_path = os.path.join(path, octave_exec)
            return matlab_exe_path
    return matlab_exe_path
</div>
<div class="viewcode-block" id="check_matlab_version"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.check_matlab_version">[docs]</a>def check_matlab_version(matlab_path):
    """
    Try to get the current version of matlab from a given path.
    """
    matlab_version_txt = """tvb_checking_version = version
    quit()
    """
    matlab_test_file = 'test_mat_version'
    matlab_log_file = 'version_log.txt'
    file_p = open(matlab_test_file + '.m', 'w')
    file_p.write(matlab_version_txt)
    file_p.close()
    os.system(matlab_cmd(matlab_path, matlab_test_file, matlab_log_file))
    log_file = open(matlab_log_file, 'r')
    result_data = log_file.read()
    version = result_data.strip().split('tvb_checking_version')[1]
    log_file.close()
    os.remove(matlab_log_file)
    os.remove(matlab_test_file + '.m')
    return version.replace('\n', '').strip()
</div>
<div class="viewcode-block" id="matlab_cmd"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.matlab_cmd">[docs]</a>def matlab_cmd(matlab_path, script_name, log_file):
    """
    Called in order to obtain the command for calling MATLAB
    """
    folder_path, exe_name = os.path.split(matlab_path)
    if folder_path not in os.environ['PATH']:
        os.environ['PATH'] = os.environ.get('PATH', '') + os.pathsep + folder_path
    if MATLAB in exe_name:
        base = exe_name + ' '
        opts = ' -nodesktop -nojvm -nosplash -logfile %s -r "%s;"' % (log_file, script_name)
        if os.name == 'nt':
            opts = '-minimize ' + opts
        return base + opts
    if OCTAVE in exe_name:
        return exe_name + ' %s.m &gt;&gt; %s' % (script_name, log_file)

################## MATLAB methods end here     ##############
    
################## GENERIC  methods start here ###############
</div>
<div class="viewcode-block" id="synchronized"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.synchronized">[docs]</a>def synchronized(lock):
    """ 
    Synchronization annotation. 
    We try to mimic the same behavior as Java has with keyword synchronized, for methods.
    """
    def wrap(func):
        """Wrap current function with a lock mechanism"""
        def new_function(*args, **kw):
            """ New function will actually write the Lock."""
            lock.acquire()
            try:
                return func(*args, **kw)
            finally:
                lock.release()
        return new_function
    return wrap
 
 </div>
<div class="viewcode-block" id="stop_pid"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.stop_pid">[docs]</a>def stop_pid(pid):
    """
    Stop a process specified by PID.
    :return: True when specified Process was stopped in here, False in case of exception(e.g. process stopped in advance).
    """
    if sys.platform == 'win32':
        try:
            import ctypes
            handle = ctypes.windll.kernel32.OpenProcess(1, False, int(pid))
            ctypes.windll.kernel32.TerminateProcess(handle, -1)
            ctypes.windll.kernel32.CloseHandle(handle)
        except WindowsError, _:
            return False
    else:
        try:
            os.kill(int(pid), signal.SIGKILL) 
        except OSError, _:
            return False
        
    return True
                        
    </div>
<div class="viewcode-block" id="generate_guid"><a class="viewcode-back" href="../../../tvb.core.html#tvb.core.utils.generate_guid">[docs]</a>def generate_guid():
    """ 
    Generate new Global Unique Identifier.
    This identifier should be unique per each station, 
    and unique for different machines.
    """
    return str(uuid.uuid1())

</div>
</pre>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>