

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller &mdash; The Virtual Brain 1.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../../',
        VERSION:     '1.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Virtual Brain 1.0.4 documentation" href="../../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller</h1><pre>
# -*- coding: utf-8 -*-
#
#
# TheVirtualBrain-Framework Package. This package holds all Data Management, and 
# Web-UI helpful to run brain-simulations. To use it, you also need do download
# TheVirtualBrain-Scientific Package (for simulators). See content of the
# documentation-folder for more details. See also http://www.thevirtualbrain.org
#
# (c) 2012-2013, Baycrest Centre for Geriatric Care ("Baycrest")
#
# This program is free software; you can redistribute it and/or modify it under 
# the terms of the GNU General Public License version 2 as published by the Free
# Software Foundation. This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
# License for more details. You should have received a copy of the GNU General 
# Public License along with this program; if not, you can download it here
# http://www.gnu.org/licenses/old-licenses/gpl-2.0
#
#

"""
.. moduleauthor:: Bogdan Neacsa &lt;bogdan.neacsa@codemart.ro&gt;
.. moduleauthor:: Ionel Ortelecan &lt;ionel.ortelecan@codemart.ro&gt;
"""

import cherrypy
import json
from copy import deepcopy

import tvb.interfaces.web.controllers.basecontroller as base
import tvb.basic.traits.traited_interface as traited_interface
from tvb.interfaces.web.controllers.basecontroller import using_template, settings
from tvb.interfaces.web.controllers.userscontroller import logged
from tvb.interfaces.web.controllers.flowcontroller import SelectedAdapterContext
from tvb.basic.traits.parameters_factory import get_traited_instance_for_name
from tvb.basic.logger.builder import get_logger
from tvb.core.adapters.abcadapter import ABCAdapter
from tvb.core.services.flowservice import FlowService
from tvb.adapters.visualizers.connectivity import ConnectivityViewer
from tvb.simulator.models import Model
from tvb.simulator.integrators import Integrator
from tvb.config import SIMULATOR_CLASS, SIMULATOR_MODULE
from tvb.datatypes import noise_framework


PARAM_CONNECTIVITY = 'connectivity'
PARAM_SURFACE = 'surface'
PARAM_MODEL = 'model'
PARAM_INTEGRATOR = 'integrator'
MODEL_PARAMETERS = 'model_parameters'
INTEGRATOR_PARAMETERS = 'integrator_parameters'
PARAMS_MODEL_PATTERN = 'model_parameters_option_%s_%s'


<div class="viewcode-block" id="SpatioTemporalController"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController">[docs]</a>class SpatioTemporalController(base.BaseController):
    """
    Base class which contains methods related to spatio-temporal actions.
    """

    def __init__(self):
        base.BaseController.__init__(self)
        self.flow_service = FlowService()
        self.logger = get_logger(__name__)
        editable_entities = []
        editable_entities.append(dict(link= '/spatial/stimulus/region/step_1_submit/1/1', title='Region Stimulus',
                                      subsection= 'regionstim', description='Create a new Stimulus on Region level'))
        editable_entities.append(dict(link= '/spatial/stimulus/surface/step_1_submit/1/1', title='Surface Stimulus',
                                      subsection= 'surfacestim', description='Create a new Stimulus on Surface level'))
        self.submenu_list = editable_entities


    @cherrypy.expose
    @using_template('base_template')
    @logged()
    @settings()
<div class="viewcode-block" id="SpatioTemporalController.index"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.index">[docs]</a>    def index(self, **data):
        """
        Displays the main page for the spatio temporal section.
        """
        template_specification = dict(title="Spatio temporal", data=data)
        template_specification['mainContent'] = 'header_menu'
        return self.fill_default_attributes(template_specification)

</div>
    @staticmethod
<div class="viewcode-block" id="SpatioTemporalController.get_connectivity_parameters"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.get_connectivity_parameters">[docs]</a>    def get_connectivity_parameters(input_connectivity, surface_data=None):
        """
        Returns a dictionary which contains all the needed data for drawing a connectivity.
        """
        viewer = ConnectivityViewer()
        global_params, global_pages = viewer.compute_connectivity_global_params(input_connectivity, surface_data)
        global_params.update(global_pages)
        global_params['selectedConnectivityGid'] = input_connectivity.gid
        return global_params

</div>
<div class="viewcode-block" id="SpatioTemporalController.get_data_from_burst_configuration"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.get_data_from_burst_configuration">[docs]</a>    def get_data_from_burst_configuration(self):
        """
        Returns the model, integrator, connectivity and surface instances from the burst configuration.
        """
        ### Read from session current burst-configuration
        burst_configuration = base.get_from_session(base.KEY_BURST_CONFIG)
        if burst_configuration is None:
            return None, None, None
        first_range = burst_configuration.get_simulation_parameter_value('first_range')
        second_range = burst_configuration.get_simulation_parameter_value('second_range')
        if ((first_range is not None and str(first_range).startswith(MODEL_PARAMETERS)) or
            (second_range is not None and str(second_range).startswith(MODEL_PARAMETERS))):
            base.set_error_message("When configuring model parameters you are not allowed to specify range values.")
            raise cherrypy.HTTPRedirect("/burst/")
        _, group = self.flow_service.get_algorithm_by_module_and_class(SIMULATOR_MODULE, SIMULATOR_CLASS)
        simulator_adapter = self.flow_service.build_adapter_instance(group)
        try:
            params_dict = simulator_adapter.convert_ui_inputs(burst_configuration.get_all_simulator_values()[0], False)
        except Exception, excep:
            self.logger.exception(excep)
            base.set_error_message("Some of the provided parameters have an invalid value.")
            raise cherrypy.HTTPRedirect("/burst/")
        ### Prepare Model instance
        model = burst_configuration.get_simulation_parameter_value(PARAM_MODEL)
        model_parameters = params_dict[MODEL_PARAMETERS]
        noise_framework.build_noise(model_parameters)
        try:
            model = get_traited_instance_for_name(model, Model, model_parameters)
        except Exception, ex:
            self.logger.exception(ex)
            self.logger.info("Could not create the model instance with the given parameters. "
                             "A new model instance will be created with the default values.")
            model = get_traited_instance_for_name(model, Model, {})
        ### Prepare Integrator instance
        integrator = burst_configuration.get_simulation_parameter_value(PARAM_INTEGRATOR)
        integrator_parameters = params_dict[INTEGRATOR_PARAMETERS]
        noise_framework.build_noise(integrator_parameters)
        try:
            integrator = get_traited_instance_for_name(integrator, Integrator, integrator_parameters)
        except Exception, ex:
            self.logger.exception(ex)
            self.logger.info("Could not create the integrator instance with the given parameters. "
                             "A new integrator instance will be created with the default values.")
            integrator = get_traited_instance_for_name(integrator, Integrator, {})
        ### Prepare Connectivity
        connectivity_gid = burst_configuration.get_simulation_parameter_value(PARAM_CONNECTIVITY)
        connectivity = ABCAdapter.load_entity_by_gid(connectivity_gid)
        ### Prepare Surface
        surface_gid = burst_configuration.get_simulation_parameter_value(PARAM_SURFACE)
        surface = None
        if surface_gid is not None and len(surface_gid):
            surface = ABCAdapter.load_entity_by_gid(surface_gid)
        return model, integrator, connectivity, surface

</div>
    @staticmethod
<div class="viewcode-block" id="SpatioTemporalController.display_surface"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.display_surface">[docs]</a>    def display_surface(surface_gid):
        """
        Generates the HTML for displaying the surface with the given ID.
        """
        surface = ABCAdapter.load_entity_by_gid(surface_gid)
        base.add2session(PARAM_SURFACE, surface_gid)
        url_vertices_pick, url_normals_pick, url_triangles_pick = surface.get_urls_for_pick_rendering()
        url_vertices, url_normals, url_triangles, alphas, alphas_indices = surface.get_urls_for_rendering(True, None)

        template_specification = dict()
        template_specification['urlVerticesPick'] = json.dumps(url_vertices_pick)
        template_specification['urlTrianglesPick'] = json.dumps(url_triangles_pick)
        template_specification['urlNormalsPick'] = json.dumps(url_normals_pick)
        template_specification['urlVertices'] = json.dumps(url_vertices)
        template_specification['urlTriangles'] = json.dumps(url_triangles)
        template_specification['urlNormals'] = json.dumps(url_normals)
        template_specification['alphas'] = json.dumps(alphas)
        template_specification['alphas_indices'] = json.dumps(alphas_indices)
        template_specification['brainCenter'] = json.dumps(surface.center())
        return template_specification

</div>
    @staticmethod
<div class="viewcode-block" id="SpatioTemporalController.prepare_entity_interface"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.prepare_entity_interface">[docs]</a>    def prepare_entity_interface(input_list):
        """
        Prepares the input tree obtained from a creator.
        """
        return {'inputList': input_list, 
                base.KEY_PARAMETERS_CONFIG: False}

</div>
<div class="viewcode-block" id="SpatioTemporalController.get_creator_and_interface"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.get_creator_and_interface">[docs]</a>    def get_creator_and_interface(self, creator_module, creator_class, datatype_instance, lock_midpoint_for_eq = None):
        """
        Returns a Tuple: a creator instance and a dictionary for the creator interface.
        The interface is prepared for rendering, it is populated with existent data, in case of a
        parameter of type DataType. The name of the attributes are also prefixed to identify groups.
        """
        _, algo_group = self.flow_service.get_algorithm_by_module_and_class(creator_module, creator_class)
        group, _ = self.flow_service.prepare_adapter(base.get_current_project().id, algo_group)

        #I didn't use the interface(from the above line) returned by the method 'prepare_adapter' from flow service
        # because the selects that display dataTypes will also have the 'All' entry.
        datatype_instance.trait.bound = traited_interface.INTERFACE_ATTRIBUTES_ONLY
        input_list = datatype_instance.interface[traited_interface.INTERFACE_ATTRIBUTES]
        if lock_midpoint_for_eq is not None:
            for idx in lock_midpoint_for_eq:
                input_list[idx] = self._lock_midpoints(input_list[idx])
        category = self.flow_service.get_visualisers_category()
        input_list = self.flow_service.prepare_parameters(input_list, base.get_current_project().id, category.id)
        input_list = ABCAdapter.prepare_param_names(input_list)

        return self.flow_service.build_adapter_instance(group), input_list

</div>
    @staticmethod
<div class="viewcode-block" id="SpatioTemporalController.get_series_json"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.get_series_json">[docs]</a>    def get_series_json(data, label):
        """ For each data point entry, build the FLOT specific JSON. """
        series = "{\"data\": " + json.dumps(data) + ","
        series += "\"label\": \"" + label + "\""
        series += "}"
        return series

</div>
    @staticmethod
<div class="viewcode-block" id="SpatioTemporalController.build_final_json"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.build_final_json">[docs]</a>    def build_final_json(list_of_series):
        """ Given a list with all the data points, build the final FLOT json. """
        final_json = "["
        for i in range(len(list_of_series)):
            if i:
                final_json += ","
            final_json += list_of_series[i]
        final_json += "]"
        return final_json

</div>
    @staticmethod
<div class="viewcode-block" id="SpatioTemporalController.get_ui_message"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.get_ui_message">[docs]</a>    def get_ui_message(list_of_equation_names):
        """
        The message returned by this method should be displayed if
        the equation with the given name couldn't be evaluated in all points.
        """
        if len(list_of_equation_names):
            return ("Could not evaluate the " + ", ".join(list_of_equation_names) + " equation(s) "
                    "in all the points. Some of the values were changed.")
        else:
            return ""

</div>
<div class="viewcode-block" id="SpatioTemporalController.get_select_existent_entities"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.get_select_existent_entities">[docs]</a>    def get_select_existent_entities(self, label, entity_type, entity_gid=None):
        """
        Returns the dictionary needed for drawing the select which display all
        the created entities of the specified type.
        """
        project_id = base.get_current_project().id
        category = self.flow_service.get_visualisers_category()
        
        interface = [{'name': 'existentEntitiesSelect', 'label': label, 'type' : entity_type}]
        if entity_gid is not None:
            interface[0]['default'] = entity_gid
        interface = self.flow_service.prepare_parameters(interface, project_id, category.id)
        interface = ABCAdapter.prepare_param_names(interface)

        return interface

</div>
    @staticmethod
<div class="viewcode-block" id="SpatioTemporalController.add_interface_to_session"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.add_interface_to_session">[docs]</a>    def add_interface_to_session(left_input_tree, right_input_tree):
        """
        left_input_tree and right_input_tree are expected to be lists of dictionaries.

        Those 2 given lists will be concatenated and added to session.
        In order to work the filters, the interface should be added to session.
        """
        entire_tree = deepcopy(left_input_tree)
        entire_tree.extend(right_input_tree)
        SelectedAdapterContext().add_adapter_to_session(None, entire_tree)
        
       </div>
<div class="viewcode-block" id="SpatioTemporalController.fill_default_attributes"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.fill_default_attributes">[docs]</a>    def fill_default_attributes(self, template_dictionary, subsection = 'stimulus'):
        """
        Overwrite base controller to add required parameters for adapter templates.
        """
        template_dictionary[base.KEY_SECTION] = 'stimulus'
        template_dictionary[base.KEY_SUB_SECTION] = subsection
        template_dictionary[base.KEY_SUBMENU_LIST] = self.submenu_list
        template_dictionary[base.KEY_INCLUDE_RESOURCES] = 'spatial/included_resources'
        base.BaseController.fill_default_attributes(self, template_dictionary)
        return template_dictionary

</div>
<div class="viewcode-block" id="SpatioTemporalController.get_x_axis_range"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.get_x_axis_range">[docs]</a>    def get_x_axis_range(self, min_x_str, max_x_str):
        """
        Fill range for the X-axis displayed in 2D graph.
        """
        min_x = 0
        max_x = 100
        error_msg = ''
        if self.is_int(min_x_str):
            min_x = int(min_x_str)

            if self.is_int(max_x_str):
                max_x = int(max_x_str)
            else:
                min_x = 0
                error_msg = "The max value for the x-axis should be an integer value."

            if min_x &gt;= max_x:
                error_msg = "The min value for the x-axis should be smaller then the max value of the x-axis."
                min_x = 0
                max_x = 100
        else:
            error_msg = "The min value for the x-axis should be an integer value."

        return min_x, max_x, error_msg
    
</div>
    @staticmethod
    def _lock_midpoints(equations_dict):
        """
        Set mid-points for gaussian / double gausians as locked to 0.0 in case of spatial equations.
        """
        for equation in equations_dict[ABCAdapter.KEY_OPTIONS]:
            if equation[ABCAdapter.KEY_NAME] == 'Gaussian':
                for entry in equation[ABCAdapter.KEY_ATTRIBUTES][1][ABCAdapter.KEY_ATTRIBUTES]:
                    if entry[ABCAdapter.KEY_NAME] == 'midpoint':
                        entry['locked'] = True
            if equation[ABCAdapter.KEY_NAME] == 'DoubleGaussian':
                for entry in equation[ABCAdapter.KEY_ATTRIBUTES][1][ABCAdapter.KEY_ATTRIBUTES]:
                    if entry[ABCAdapter.KEY_NAME] == 'midpoint1':
                        entry['locked'] = True
        return equations_dict


    @staticmethod
<div class="viewcode-block" id="SpatioTemporalController.is_int"><a class="viewcode-back" href="../../../../../../tvb.interfaces.web.controllers.spatial.html#tvb.interfaces.web.controllers.spatial.base_spatiotemporalcontroller.SpatioTemporalController.is_int">[docs]</a>    def is_int(str_value):
        """
        Checks if the given string may be converted to an int value.
        """
        try:
            int(str_value)
            return True
        except Exception, _:
            return False
        
        
        </div></div>
</pre>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>