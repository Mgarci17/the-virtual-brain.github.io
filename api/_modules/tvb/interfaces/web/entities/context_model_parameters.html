

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.interfaces.web.entities.context_model_parameters &mdash; The Virtual Brain 1.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '1.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Virtual Brain 1.0.4 documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.interfaces.web.entities.context_model_parameters</h1><pre>
# -*- coding: utf-8 -*-
#
#
# TheVirtualBrain-Framework Package. This package holds all Data Management, and 
# Web-UI helpful to run brain-simulations. To use it, you also need do download
# TheVirtualBrain-Scientific Package (for simulators). See content of the
# documentation-folder for more details. See also http://www.thevirtualbrain.org
#
# (c) 2012-2013, Baycrest Centre for Geriatric Care ("Baycrest")
#
# This program is free software; you can redistribute it and/or modify it under 
# the terms of the GNU General Public License version 2 as published by the Free
# Software Foundation. This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
# License for more details. You should have received a copy of the GNU General 
# Public License along with this program; if not, you can download it here
# http://www.gnu.org/licenses/old-licenses/gpl-2.0
#
#

"""
.. moduleauthor:: Ionel Ortelecan &lt;ionel.ortelecan@codemart.ro&gt;
"""

import numpy
from copy import deepcopy

import tvb.basic.traits.traited_interface as interface
import tvb.basic.traits.parameters_factory as parameters_factory
from tvb.basic.logger.builder import get_logger
from tvb.basic.traits.core import Type
from tvb.core.adapters.abcadapter import KEY_EQUATION, KEY_FOCAL_POINTS, KEY_SURFACE_GID, ABCAdapter
from tvb.datatypes.equations import SpatialApplicableEquation, Gaussian
from tvb.adapters.visualizers.phase_plane_interactive import PhasePlaneInteractive
import tvb.simulator.models as models_module
import tvb.simulator.integrators as integrators_module



KEY_FOCAL_POINTS_TRIANGLES = "focal_points_triangles"

<div class="viewcode-block" id="ContextModelParameters"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.ContextModelParameters">[docs]</a>class ContextModelParameters():
    """
    This class behaves like a controller. The model for this controller will
    be the fields defined into the init method and the view is represented
    by a PhasePlaneInteractive instance.

    This class may also be used into the desktop application.
    """

    def __init__(self, connectivity, default_model = None,
                 default_integrator = None, compute_phase_plane_params = True):
        self.logger = get_logger(self.__class__.__module__)
        self.default_model = default_model
        self.default_integrator = default_integrator
        self.connectivity = connectivity
        self.connectivity_models = dict()

        if self.default_model is None:
            self.default_model = models_module.Generic2dOscillator()
        if self.default_integrator is None:
            self.default_integrator = integrators_module.RungeKutta4thOrderDeterministic()

        self.model_parameter_names = deepcopy(self.default_model.ui_configurable_parameters)
        if not len(self.model_parameter_names):
            self.logger.warning("The 'ui_configurable_parameters' list of the current model is empty!")
        self.prepared_model_parameter_names = self._prepare_parameter_names(self.model_parameter_names)

        model = self._get_model_for_region(0)
        if compute_phase_plane_params:
            self._phase_plane = PhasePlaneInteractive(deepcopy(model), deepcopy(self.default_integrator))
            self.phase_plane_params = self._phase_plane.draw_phase_plane()


    @property
<div class="viewcode-block" id="ContextModelParameters.model_name"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.ContextModelParameters.model_name">[docs]</a>    def model_name(self):
        """
        Get class-name for the simulation model saved in current context.
        """
        return self.default_model.__class__.__name__

</div>
    @staticmethod
    def _prepare_parameter_names(parameter_names):
        """
        Used for removing the '_' character from the parameter_names.
        """
        #{$orig_param: $new_param}
        result = {}
        for param in parameter_names:
            result[param] = param.replace("_", "")
        return result

    

    def _get_model_for_region(self, connectivity_node_index):
        """
        Returns the model instance corresponding to the connectivity node found at the specified index.
        """
        connectivity_node_index = int(connectivity_node_index)
        if connectivity_node_index not in self.connectivity_models:
            model = self._compute_default_model(connectivity_node_index)
            self.connectivity_models[connectivity_node_index] = deepcopy(model)
        return self.connectivity_models[connectivity_node_index]


<div class="viewcode-block" id="ContextModelParameters.load_model_for_connectivity_node"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.ContextModelParameters.load_model_for_connectivity_node">[docs]</a>    def load_model_for_connectivity_node(self, connectivity_node_index):
        """
        Sets the parameters of the model found into the phase_plane instance
        to the parameters of the model of the specified connectivity node.
        """
        connectivity_node_index = int(connectivity_node_index)
        model = self._get_model_for_region(connectivity_node_index)
        self._phase_plane.update_all_model_parameters(model)

</div>
<div class="viewcode-block" id="ContextModelParameters.update_model_parameter"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.ContextModelParameters.update_model_parameter">[docs]</a>    def update_model_parameter(self, connectivity_node_index, param_name, param_value):
        """
        Updates the given parameter of the model used by the given connectivity node.
        """
        connectivity_node_index = int(connectivity_node_index)
        if connectivity_node_index &lt; 0:
            return

        param_value = float(param_value)
        model = self._get_model_for_region(connectivity_node_index)
        setattr(model, param_name, numpy.array([param_value]))
        self._phase_plane.update_model_parameter(param_name, param_value)

</div>
<div class="viewcode-block" id="ContextModelParameters.set_model_for_connectivity_nodes"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.ContextModelParameters.set_model_for_connectivity_nodes">[docs]</a>    def set_model_for_connectivity_nodes(self, source_node_index_for_model, connectivity_node_indexes):
        """
        Set the model for all the nodes specified in 'connectivity_node_indexes' list to
        the model of the node with index 'source_node_index_for_model'
        """
        source_node_index = int(source_node_index_for_model)
        model = self._get_model_for_region(source_node_index)
        for index in connectivity_node_indexes:
            self.connectivity_models[int(index)] = deepcopy(model)

</div>
<div class="viewcode-block" id="ContextModelParameters.reset_model_parameters_for_nodes"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.ContextModelParameters.reset_model_parameters_for_nodes">[docs]</a>    def reset_model_parameters_for_nodes(self, connectivity_node_indexes):
        """
        Resets all the model parameters for each node specified in the 'connectivity_node_indexes'
        list. The parameters will be reset to their default values.
        """
        if not len(connectivity_node_indexes):
            return
        for index in connectivity_node_indexes:
            index = int(index)
            if index &lt; 0:
                continue
            model = self._compute_default_model(index)
            self.connectivity_models[index] = deepcopy(model)

</div>
<div class="viewcode-block" id="ContextModelParameters.get_data_for_param_sliders"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.ContextModelParameters.get_data_for_param_sliders">[docs]</a>    def get_data_for_param_sliders(self, connectivity_node_index):
        """
        NOTE: This method may throw 'ValueError' exception.

        Return a dict which contains all the needed information for
        drawing the sliders for the model parameters of the selected connectivity node.
        """
        connectivity_node_index = int(connectivity_node_index)
        current_model = self._get_model_for_region(connectivity_node_index)
        #we have to obtain the model with its default values(the one submitted from burst may have some
        # parameters values changed); the step is computed based on the number of decimals of the default values
        default_model_for_node = parameters_factory.get_traited_instance_for_name(self.model_name , 
                                                                                  models_module.Model, {})
        param_sliders_data = dict()
        for param_name in self.model_parameter_names:
            current_value = getattr(current_model, param_name)
            ### Convert to list to avoid having non-serializable values numpy.int32
            if isinstance(current_value, numpy.ndarray):
                current_value = current_value.tolist()[0]
            else:
                #check if the current_value represents a valid number
                #handle the exception in the place where you call this method
                float(current_value)
            ranger = default_model_for_node.trait[param_name].trait.range_interval

            if current_value &gt; ranger.hi:
                current_value = ranger.hi
                self.update_model_parameter(connectivity_node_index, param_name, current_value)
            if current_value &lt; ranger.lo:
                current_value = ranger.lo
                self.update_model_parameter(connectivity_node_index, param_name, current_value)

            param_sliders_data[param_name] = {'min': ranger.lo, 'max': ranger.hi, 
                                              'default': current_value, 'step': ranger.step}
        param_sliders_data['all_param_names'] = self.model_parameter_names
        return param_sliders_data

</div>
<div class="viewcode-block" id="ContextModelParameters.get_values_for_parameter"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.ContextModelParameters.get_values_for_parameter">[docs]</a>    def get_values_for_parameter(self, parameter_name):
        """
        Returns a list which contains the values for the given model
        parameter name. The values are collected from each node of the used connectivity.

        If all the parameter values are equal then a list with
        one value will be returned.
        """
        default_attr = getattr(self.default_model, parameter_name)
        if isinstance(default_attr, numpy.ndarray):
            default_attr = default_attr.tolist()
        else:
            #if the user set the parameter as a number
            default_attr = [default_attr]

        if len(self.connectivity_models):
            param_values = []
            for i in range(self.connectivity.number_of_regions):
                if i in self.connectivity_models:
                    current_model = self.connectivity_models[i]
                    current_attr = getattr(current_model, parameter_name)
                    if isinstance(current_attr, numpy.ndarray):
                        current_attr = current_attr[0]
                    param_values.append(current_attr)
                else:
                    if 1 &lt; len(default_attr) &gt; i:
                        param_values.append(default_attr[i])
                    else:
                        param_values.append(default_attr[0])
            #check if all the values are equals
            if param_values.count(param_values[0]) != len(param_values):
                return str(param_values)
            else:
                return str([default_attr[0]])

        return deepcopy(str(default_attr))

</div>
    def _compute_default_model(self, connectivity_node_index):
        """
        Computes the default model for the given connectivity node.

        If the parameters of the default model contain values for all the nodes
        of the connectivity, than this method will build a new model which will
        have the parameters set to a numpy array with a single value. The value
        is computed from the default model parameter values.
        """
        model = deepcopy(self.default_model)
        for parameter_name in self.model_parameter_names:
            default_attr = getattr(model, parameter_name)
            if isinstance(default_attr, numpy.ndarray):
                default_attr = default_attr.tolist()
                if len(default_attr) &gt; 1:
                    if len(default_attr) &lt;= connectivity_node_index:
                        setattr(model, parameter_name, numpy.array([default_attr[0]]))
                    else:
                        setattr(model, parameter_name, numpy.array([default_attr[connectivity_node_index]]))
        return model

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters">[docs]</a>class SurfaceContextModelParameters(ContextModelParameters):
    """
    This class contains methods which allows you to edit the model
    parameters for each vertex of the given surface.
    """
    def __init__(self, surface, connectivity, default_model = None, default_integrator = None):
        ContextModelParameters.__init__(self, connectivity, default_model, default_integrator, False)
        self.surface = surface
        self.applied_equations = dict()


<div class="viewcode-block" id="SurfaceContextModelParameters.apply_equation"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.apply_equation">[docs]</a>    def apply_equation(self, param_name, equation_instance):
        """
        Applies an equation on the given model parameter.
        """
        if param_name in self.applied_equations:
            param_data = self.applied_equations[param_name]
            param_data[KEY_EQUATION] = equation_instance
        else:
            self.applied_equations[param_name] = {KEY_EQUATION : equation_instance, KEY_FOCAL_POINTS: [],
                                                  KEY_SURFACE_GID: self.surface.gid, KEY_FOCAL_POINTS_TRIANGLES: [],
                                                  ABCAdapter.KEY_DTYPE: equation_instance.__class__.__module__ + '.' 
                                                                        + equation_instance.__class__.__name__}

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters.apply_focal_point"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.apply_focal_point">[docs]</a>    def apply_focal_point(self, model_param, triangle_index):
        """
        NOTE: Expects a triangle index

        Adds a focal point in which should be applied the equation for the given model parameter.
        """
        triangle_index = int(triangle_index)
        if model_param in self.applied_equations:
            if triangle_index &gt;= 0:
                vertex_index = int(self.surface.triangles[triangle_index][0])
                if vertex_index not in self.applied_equations[model_param][KEY_FOCAL_POINTS]:
                    self.applied_equations[model_param][KEY_FOCAL_POINTS].append(vertex_index)
                    self.applied_equations[model_param][KEY_FOCAL_POINTS_TRIANGLES].append(triangle_index)

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters.remove_focal_point"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.remove_focal_point">[docs]</a>    def remove_focal_point(self, model_param, triangle_index):
        """
        NOTE: Expects a vertex index

        Removes a focal point from the list of focal points in which should be
        applied the equation for the given model parameter.
        """
        triangle_index = int(triangle_index)
        if model_param in self.applied_equations:
            if triangle_index &gt;= 0:
                if triangle_index in self.applied_equations[model_param][KEY_FOCAL_POINTS_TRIANGLES]:
                    f_p_idx = self.applied_equations[model_param][KEY_FOCAL_POINTS_TRIANGLES].index(triangle_index)
                    self.applied_equations[model_param][KEY_FOCAL_POINTS].remove(
                                                    self.applied_equations[model_param][KEY_FOCAL_POINTS][f_p_idx])
                    self.applied_equations[model_param][KEY_FOCAL_POINTS_TRIANGLES].remove(triangle_index)

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters.reset_equations_for_all_parameters"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.reset_equations_for_all_parameters">[docs]</a>    def reset_equations_for_all_parameters(self):
        """
        Reset the equations for all the model parameters.
        """
        self.applied_equations = dict()

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters.reset_param_equation"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.reset_param_equation">[docs]</a>    def reset_param_equation(self, model_param):
        """
        Resets the equation for the specified model parameter.
        """
        if model_param in self.applied_equations:
            self.applied_equations.pop(model_param)

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters.get_equation_for_parameter"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.get_equation_for_parameter">[docs]</a>    def get_equation_for_parameter(self, parameter_name):
        """
        Returns the applied equation for the given model param.

        Returns None if there is no equation applied to this param.
        """
        if parameter_name in self.applied_equations and \
           KEY_EQUATION in self.applied_equations[parameter_name]:
            return self.applied_equations[parameter_name][KEY_EQUATION]
        return None

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters.get_focal_points_for_parameter"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.get_focal_points_for_parameter">[docs]</a>    def get_focal_points_for_parameter(self, parameter_name):
        """
        Returns the list of focal points for the equation applied in the given model param.
        """
        if parameter_name in self.applied_equations and\
           KEY_FOCAL_POINTS in self.applied_equations[parameter_name]:
            return self.applied_equations[parameter_name][KEY_FOCAL_POINTS_TRIANGLES]
        return []

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters.get_data_for_model_param"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.get_data_for_model_param">[docs]</a>    def get_data_for_model_param(self, original_param_name, modified_param_name):
        """
        Returns:
         - a dictionary of form: {'equation': $equation, 'focal_points': $list_of_focal_points,
         'no_of_vertices':$surface_no_of_vertices} if the user specified any equation for computing
         the value of the given parameter.
         - a string of form: '[$default_model_param_value]' if the user didn't specified any equation for the given param
        """
        if modified_param_name in self.applied_equations:
            return self.applied_equations[modified_param_name]
        else:
            default_attr = deepcopy(getattr(self.default_model, original_param_name))
            if isinstance(default_attr, numpy.ndarray):
                default_attr = default_attr.tolist()
                return str([default_attr[0]])
            return str([default_attr])

</div>
<div class="viewcode-block" id="SurfaceContextModelParameters.get_configure_info"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.SurfaceContextModelParameters.get_configure_info">[docs]</a>    def get_configure_info(self):
        """
        Returns a dictionary which contains information about the
        applied equations on the model parameters.
        """
        result = {}
        for param in  self.applied_equations:
            equation = self.applied_equations[param][KEY_EQUATION]
            keys = sorted(equation.parameters.keys(), key=lambda x: len(x))
            keys.reverse()
            base_equation = equation.trait['equation'].interface['description']
            for eq_param in keys:
                while True:
                    stripped_eq = "".join(base_equation.split())
                    param_idx = stripped_eq.find('\\' + eq_param)
                    if param_idx &lt; 0:
                        break
                    #If parameter is precedeed by an alfanumerical character replace with multiplicative sign 
                    if param_idx &gt; 0 and stripped_eq[param_idx - 1].isalnum():
                        base_equation = base_equation.replace('\\'+eq_param, '*' + str(equation.parameters[eq_param]))
                    else:
                        base_equation = base_equation.replace('\\'+eq_param, str(equation.parameters[eq_param]))
                base_equation = base_equation.replace(eq_param, str(equation.parameters[eq_param]))
            focal_points = str(self.applied_equations[param][KEY_FOCAL_POINTS])
            result[param] = {'equation_name': equation.__class__.__name__,
                             'equation_params': base_equation, 'focal_points': focal_points}
        return result
    
    
    </div></div>
<div class="viewcode-block" id="EquationDisplayer"><a class="viewcode-back" href="../../../../../tvb.interfaces.web.entities.html#tvb.interfaces.web.entities.context_model_parameters.EquationDisplayer">[docs]</a>class EquationDisplayer(Type):
    """
    Class used for generating the UI related to equations.
    """
    model_param_equation = SpatialApplicableEquation(label='Equation', default = Gaussian)
    
    
    
    
    </pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>