<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.core.adapters.abcadapter &mdash; The Virtual Brain 1.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="The Virtual Brain 1.1 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">The Virtual Brain 1.1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.core.adapters.abcadapter</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c"># TheVirtualBrain-Framework Package. This package holds all Data Management, and </span>
<span class="c"># Web-UI helpful to run brain-simulations. To use it, you also need do download</span>
<span class="c"># TheVirtualBrain-Scientific Package (for simulators). See content of the</span>
<span class="c"># documentation-folder for more details. See also http://www.thevirtualbrain.org</span>
<span class="c">#</span>
<span class="c"># (c) 2012-2013, Baycrest Centre for Geriatric Care (&quot;Baycrest&quot;)</span>
<span class="c">#</span>
<span class="c"># This program is free software; you can redistribute it and/or modify it under </span>
<span class="c"># the terms of the GNU General Public License version 2 as published by the Free</span>
<span class="c"># Software Foundation. This program is distributed in the hope that it will be</span>
<span class="c"># useful, but WITHOUT ANY WARRANTY; without even the implied warranty of </span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public</span>
<span class="c"># License for more details. You should have received a copy of the GNU General </span>
<span class="c"># Public License along with this program; if not, you can download it here</span>
<span class="c"># http://www.gnu.org/licenses/old-licenses/gpl-2.0</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="c">#   CITATION:</span>
<span class="c"># When using The Virtual Brain for scientific publications, please cite it as follows:</span>
<span class="c">#</span>
<span class="c">#   Paula Sanz Leon, Stuart A. Knock, M. Marmaduke Woodman, Lia Domide,</span>
<span class="c">#   Jochen Mersmann, Anthony R. McIntosh, Viktor Jirsa (2013)</span>
<span class="c">#       The Virtual Brain: a simulator of primate brain network dynamics.</span>
<span class="c">#   Frontiers in Neuroinformatics (7:10. doi: 10.3389/fninf.2013.00010)</span>
<span class="c">#</span>
<span class="c">#</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Root classes for adding custom functionality to the code.</span>

<span class="sd">.. moduleauthor:: Lia Domide &lt;lia.domide@codemart.ro&gt;</span>
<span class="sd">.. moduleauthor:: Bogdan Neacsa &lt;bogdan.neacsa@codemart.ro&gt;</span>
<span class="sd">.. moduleauthor:: Yann Gordon &lt;yann@tvb.invalid&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">psutil</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">tvb.basic.config.settings</span> <span class="kn">import</span> <span class="n">TVBSettings</span> <span class="k">as</span> <span class="n">cfg</span>
<span class="kn">from</span> <span class="nn">tvb.basic.logger.builder</span> <span class="kn">import</span> <span class="n">get_logger</span>
<span class="kn">from</span> <span class="nn">tvb.basic.traits.types_mapped</span> <span class="kn">import</span> <span class="n">MappedType</span>
<span class="kn">from</span> <span class="nn">tvb.core.utils</span> <span class="kn">import</span> <span class="n">date2string</span><span class="p">,</span> <span class="n">string2array</span><span class="p">,</span> <span class="n">LESS_COMPLEX_TIME_FORMAT</span>
<span class="kn">from</span> <span class="nn">tvb.core.entities.storage</span> <span class="kn">import</span> <span class="n">dao</span>
<span class="kn">from</span> <span class="nn">tvb.core.entities.file.files_helper</span> <span class="kn">import</span> <span class="n">FilesHelper</span>
<span class="kn">from</span> <span class="nn">tvb.core.entities.file.files_update_manager</span> <span class="kn">import</span> <span class="n">FilesUpdateManager</span>
<span class="kn">from</span> <span class="nn">tvb.core.entities.file.exceptions</span> <span class="kn">import</span> <span class="n">FileVersioningException</span>
<span class="kn">from</span> <span class="nn">tvb.core.entities.transient.structure_entities</span> <span class="kn">import</span> <span class="n">DataTypeMetaData</span>
<span class="kn">from</span> <span class="nn">tvb.core.adapters.exceptions</span> <span class="kn">import</span> <span class="n">IntrospectionException</span><span class="p">,</span> <span class="n">InvalidParameterException</span><span class="p">,</span> <span class="n">LaunchException</span>
<span class="kn">from</span> <span class="nn">tvb.core.adapters.exceptions</span> <span class="kn">import</span> <span class="n">NoMemoryAvailableException</span>
<span class="kn">from</span> <span class="nn">tvb.core.adapters.xml_reader</span> <span class="kn">import</span> <span class="n">ELEM_OPTIONS</span><span class="p">,</span> <span class="n">ELEM_OUTPUTS</span><span class="p">,</span> <span class="n">INPUTS_KEY</span>

<span class="kn">import</span> <span class="nn">tvb.basic.traits.traited_interface</span> <span class="kn">as</span> <span class="nn">interface</span>
<span class="kn">import</span> <span class="nn">tvb.core.adapters.xml_reader</span> <span class="kn">as</span> <span class="nn">xml_reader</span>

<span class="n">ATT_METHOD</span> <span class="o">=</span> <span class="s">&quot;python_method&quot;</span>
<span class="n">ATT_PARAMETERS</span> <span class="o">=</span> <span class="s">&quot;parameters_prefix&quot;</span>

<span class="n">KEY_EQUATION</span> <span class="o">=</span> <span class="s">&quot;equation&quot;</span>
<span class="n">KEY_FOCAL_POINTS</span> <span class="o">=</span> <span class="s">&quot;focal_points&quot;</span>
<span class="n">KEY_SURFACE_GID</span> <span class="o">=</span> <span class="s">&quot;surface_gid&quot;</span>



<div class="viewcode-block" id="nan_not_allowed"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.nan_not_allowed">[docs]</a><span class="k">def</span> <span class="nf">nan_not_allowed</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Annotation that guides NumPy behavior in case of floating point errors.</span>
<span class="sd">    The NumPy default is to just print a warning to sys.stdout, this annotation will raise our custom exception.</span>
<span class="sd">    This annotation will enforce that an exception is thrown in case a floating point error is produced.</span>

<span class="sd">    e.g. If NaN is take as input and not produced inside the context covered by this annotation,</span>
<span class="sd">         nothing happens from this method p.o.v.</span>

<span class="sd">    e.g. If inside a method annotated with this method we have something like numpy.log(-1),</span>
<span class="sd">         then LaunchException is thrown.</span>

<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrap current function with a lock mechanism&quot;&quot;&quot;</span>


        <span class="k">def</span> <span class="nf">new_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; New function will actually write the Lock.&quot;&quot;&quot;</span>
            <span class="n">old_fp_error_handling</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span><span class="o">=</span><span class="s">&#39;raise&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s">&#39;raise&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">FloatingPointError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">LaunchException</span><span class="p">(</span><span class="s">&#39;NaN values were generated during launch. Stopping operation execution.&#39;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="o">**</span><span class="n">old_fp_error_handling</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">new_function</span>


    <span class="k">return</span> <span class="n">wrap</span>


</div>
<div class="viewcode-block" id="nan_allowed"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.nan_allowed">[docs]</a><span class="k">def</span> <span class="nf">nan_allowed</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Annotation that configures NumPy not to throw an exception in case of floating points errors are computed.</span>
<span class="sd">    It should be used on Adapter methods where computation of NaN/ Inf/etc. is allowed.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrap current function with a lock mechanism&quot;&quot;&quot;</span>


        <span class="k">def</span> <span class="nf">new_function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; New function will actually write the Lock.&quot;&quot;&quot;</span>
            <span class="n">old_fp_error_handling</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="o">**</span><span class="n">old_fp_error_handling</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">new_function</span>


    <span class="k">return</span> <span class="n">wrap</span>


</div>
<div class="viewcode-block" id="ABCAdapter"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter">[docs]</a><span class="k">class</span> <span class="nc">ABCAdapter</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Root Abstract class for all TVB Adapters. </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">TYPE_SELECT</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_SELECT</span>
    <span class="n">TYPE_MULTIPLE</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_MULTIPLE</span>
    <span class="n">STATIC_ACCEPTED_TYPES</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ALL_TYPES</span>
    <span class="n">KEY_TYPE</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span>
    <span class="n">KEY_OPTIONS</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ELEM_OPTIONS</span>
    <span class="n">KEY_ATTRIBUTES</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_ATTRIBUTES</span>
    <span class="n">KEY_NAME</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span>
    <span class="n">KEY_VALUE</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_VALUE</span>
    <span class="n">KEY_LABEL</span> <span class="o">=</span> <span class="s">&quot;label&quot;</span>
    <span class="n">KEY_DEFAULT</span> <span class="o">=</span> <span class="s">&quot;default&quot;</span>
    <span class="n">KEY_DATATYPE</span> <span class="o">=</span> <span class="s">&#39;datatype&#39;</span>
    <span class="n">KEY_DTYPE</span> <span class="o">=</span> <span class="s">&#39;elementType&#39;</span>
    <span class="n">KEY_DISABLED</span> <span class="o">=</span> <span class="s">&quot;disabled&quot;</span>
    <span class="n">KEY_ALL</span> <span class="o">=</span> <span class="s">&quot;allValue&quot;</span>
    <span class="n">KEY_CONDITION</span> <span class="o">=</span> <span class="s">&quot;conditions&quot;</span>
    <span class="n">KEY_FILTERABLE</span> <span class="o">=</span> <span class="s">&quot;filterable&quot;</span>
    <span class="n">KEY_REQUIRED</span> <span class="o">=</span> <span class="s">&quot;required&quot;</span>
    <span class="n">KEY_ID</span> <span class="o">=</span> <span class="s">&#39;id&#39;</span>
    <span class="n">KEY_UI_HIDE</span> <span class="o">=</span> <span class="s">&quot;ui_hidden&quot;</span>

    <span class="n">LAUNCH_METHOD</span> <span class="o">=</span> <span class="s">&quot;launch&quot;</span>

    <span class="n">KEYWORD_PARAMS</span> <span class="o">=</span> <span class="s">&quot;_parameters_&quot;</span>
    <span class="n">KEYWORD_SEPARATOR</span> <span class="o">=</span> <span class="s">&quot;_&quot;</span>
    <span class="n">KEYWORD_OPTION</span> <span class="o">=</span> <span class="s">&quot;option_&quot;</span>

    <span class="n">INTERFACE_ATTRIBUTES_ONLY</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">INTERFACE_ATTRIBUTES_ONLY</span>
    <span class="n">INTERFACE_ATTRIBUTES</span> <span class="o">=</span> <span class="n">interface</span><span class="o">.</span><span class="n">INTERFACE_ATTRIBUTES</span>

    <span class="c"># Group that will be set for each adapter created by in build_adapter method</span>
    <span class="n">algorithm_group</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">_ui_display</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># It will be populate with key from DataTypeMetaData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span> <span class="o">=</span> <span class="p">{</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_SUBJECT</span><span class="p">:</span> <span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">DEFAULT_SUBJECT</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span> <span class="o">=</span> <span class="n">FilesHelper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span>
        <span class="c"># Will be populate with current running operation&#39;s identifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span><span class="p">)</span>


    <span class="nd">@abstractmethod</span>
<div class="viewcode-block" id="ABCAdapter.get_input_tree"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.get_input_tree">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes inputs and outputs of the launch method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

</div>
    <span class="nd">@abstractmethod</span>
<div class="viewcode-block" id="ABCAdapter.get_output"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Describes inputs and outputs of the launch method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

</div>
<div class="viewcode-block" id="ABCAdapter.configure"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.configure">[docs]</a>    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be implemented in each Adapter that requires any specific configurations</span>
<span class="sd">        before the actual launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

</div>
    <span class="nd">@abstractmethod</span>
<div class="viewcode-block" id="ABCAdapter.get_required_memory_size"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.get_required_memory_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_required_memory_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to be implemented in each adapter. Should return the required memory</span>
<span class="sd">        for launching the adapter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

</div>
    <span class="nd">@abstractmethod</span>
<div class="viewcode-block" id="ABCAdapter.get_required_disk_size"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.get_required_disk_size">[docs]</a>    <span class="k">def</span> <span class="nf">get_required_disk_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Abstract method to be implemented in each adapter. Should return the required memory</span>
<span class="sd">        for launching the adapter in kilo-Bytes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
        
</div>
<div class="viewcode-block" id="ABCAdapter.get_execution_time_approximation"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.get_execution_time_approximation">[docs]</a>    <span class="k">def</span> <span class="nf">get_execution_time_approximation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method should approximate based on input arguments, the time it will take for the operation </span>
<span class="sd">        to finish (in seconds).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

</div>
    <span class="nd">@abstractmethod</span>
<div class="viewcode-block" id="ABCAdapter.launch"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.launch">[docs]</a>    <span class="k">def</span> <span class="nf">launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         To be implemented in each Adapter.</span>
<span class="sd">         Will contain the logic of the Adapter.</span>
<span class="sd">         Any returned DataType will be stored in DB, by the Framework.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

</div>
    <span class="nd">@nan_not_allowed</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">_prelaunch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">operation</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">available_disk_space</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to wrap LAUNCH.</span>
<span class="sd">        Will prepare data, and store results on return. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">meta_data</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">get_project_folder</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">operation</span><span class="o">.</span><span class="n">method_name</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">LAUNCH_METHOD</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">fk_launched_by</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">total_free_memory</span> <span class="o">=</span> <span class="n">psutil</span><span class="o">.</span><span class="n">virtual_memory</span><span class="p">()</span><span class="o">.</span><span class="n">free</span> <span class="o">+</span> <span class="n">psutil</span><span class="o">.</span><span class="n">swap_memory</span><span class="p">()</span><span class="o">.</span><span class="n">free</span>
            <span class="n">adapter_required_memory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_required_memory_size</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">adapter_required_memory</span> <span class="o">&gt;</span> <span class="n">total_free_memory</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoMemoryAvailableException</span><span class="p">(</span><span class="s">&quot;Machine does not have enough memory to launch the operation &quot;</span>
                                                 <span class="s">&quot;(expected </span><span class="si">%.2g</span><span class="s"> GB free, found </span><span class="si">%.2g</span><span class="s">).&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                                 <span class="n">adapter_required_memory</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span><span class="p">,</span> <span class="n">total_free_memory</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">**</span> <span class="mi">30</span><span class="p">))</span>

            <span class="n">required_disk_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_required_disk_size</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">available_disk_space</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoMemoryAvailableException</span><span class="p">(</span><span class="s">&quot;You have exceeded you HDD space quota&quot;</span>
                                                 <span class="s">&quot; by </span><span class="si">%d</span><span class="s">. Stopping execution.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">available_disk_space</span><span class="p">,))</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">available_disk_space</span> <span class="o">-</span> <span class="n">required_disk_space</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">NoMemoryAvailableException</span><span class="p">(</span><span class="s">&quot;You only have </span><span class="si">%s</span><span class="s"> kiloBytes of HDD available but the operation you &quot;</span>
                                                 <span class="s">&quot;launched might require </span><span class="si">%d</span><span class="s">. &quot;</span>
                                                 <span class="s">&quot;Stopping execution...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">available_disk_space</span><span class="p">,</span> <span class="n">required_disk_space</span><span class="p">))</span>
            <span class="n">operation</span><span class="o">.</span><span class="n">start_now</span><span class="p">()</span>
            <span class="n">operation</span><span class="o">.</span><span class="n">result_disk_size</span> <span class="o">=</span> <span class="n">required_disk_space</span>
            <span class="n">dao</span><span class="o">.</span><span class="n">store_entity</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">launch</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">,</span> <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__check_integrity</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;self.&quot;</span> <span class="o">+</span> <span class="n">operation</span><span class="o">.</span><span class="n">method_name</span> <span class="o">+</span> <span class="s">&quot;(**kwargs)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">,</span> <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capture_operation_results</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">uid</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_capture_operation_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">unique_id</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         After an operation was finished, make sure the results are stored </span>
<span class="sd">        in DB storage and the correct meta-data,IDs are set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results_to_store</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">data_type_group_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_operation_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">operation</span><span class="o">.</span><span class="n">user_group</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">user_group</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">operation</span><span class="o">.</span><span class="n">user_group</span> <span class="o">=</span> <span class="n">date2string</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span> <span class="n">date_format</span><span class="o">=</span><span class="n">LESS_COMPLEX_TIME_FORMAT</span><span class="p">)</span>
            <span class="n">operation</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">store_entity</span><span class="p">(</span><span class="n">operation</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_group_launch</span><span class="p">():</span>
            <span class="n">data_type_group_id</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_datatypegroup_by_op_group_id</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">fk_operation_group</span><span class="p">)</span><span class="o">.</span><span class="n">id</span>
        <span class="c"># All entities will have the same subject and state</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_SUBJECT</span><span class="p">]</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_STATE</span><span class="p">]</span>
        <span class="n">burst_reference</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_BURST</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
            <span class="n">burst_reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_BURST</span><span class="p">]</span>
        <span class="n">perpetuated_identifier</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_TAG_1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">:</span>
            <span class="n">perpetuated_identifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_TAG_1</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">res</span><span class="o">.</span><span class="n">subject</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">subject</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
            <span class="n">res</span><span class="o">.</span><span class="n">fk_parent_burst</span> <span class="o">=</span> <span class="n">burst_reference</span>
            <span class="n">res</span><span class="o">.</span><span class="n">fk_from_operation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span>
            <span class="n">res</span><span class="o">.</span><span class="n">framework_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span>
            <span class="n">res</span><span class="o">.</span><span class="n">user_tag_1</span> <span class="o">=</span> <span class="n">unique_id</span> <span class="k">if</span> <span class="n">unique_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="k">else</span> <span class="n">perpetuated_identifier</span>
            <span class="n">res</span><span class="o">.</span><span class="n">fk_datatype_group</span> <span class="o">=</span> <span class="n">data_type_group_id</span>
            <span class="c">## Compute size-on disk, in case file-storage is used</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">&#39;storage_path&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s">&#39;get_storage_file_name&#39;</span><span class="p">):</span>
                <span class="n">associated_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">storage_path</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">get_storage_file_name</span><span class="p">())</span>
                <span class="n">res</span><span class="o">.</span><span class="n">close_file</span><span class="p">()</span>
                <span class="n">res</span><span class="o">.</span><span class="n">disk_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_handler</span><span class="o">.</span><span class="n">compute_size_on_disk</span><span class="p">(</span><span class="n">associated_file</span><span class="p">)</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">store_entity</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="c"># Write metaData</span>
            <span class="n">res</span><span class="o">.</span><span class="n">persist_full_metadata</span><span class="p">()</span>
            <span class="n">results_to_store</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">del</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)]</span>
        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">results_to_store</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_group_launch</span><span class="p">():</span>
            <span class="c">## Update the operation group name</span>
            <span class="n">operation_group</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_operationgroup_by_id</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">fk_operation_group</span><span class="p">)</span>
            <span class="n">operation_group</span><span class="o">.</span><span class="n">fill_operationgroup_name</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>
            <span class="n">dao</span><span class="o">.</span><span class="n">store_entity</span><span class="p">(</span><span class="n">operation_group</span><span class="p">)</span>

        <span class="k">return</span> <span class="s">&#39;Operation &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; has finished.&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">results_to_store</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__check_integrity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Check that the returned parameters for LAUNCH operation</span>
<span class="sd">        are of the type specified in the adapter&#39;s interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">entity_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__module__</span> <span class="o">+</span> <span class="s">&#39;.&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>

        <span class="k">for</span> <span class="n">result_entity</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">result_entity</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_entity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c">#### Determine the first element not None</span>
                <span class="n">first_item</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result_entity</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">first_item</span> <span class="o">=</span> <span class="n">res</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">first_item</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">return</span>
                    <span class="c">#### All list items are None</span>
                <span class="c">#### Now check if the first item has a supported type</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_data_in_supported_types</span><span class="p">(</span><span class="n">first_item</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unexpected DataType </span><span class="si">%s</span><span class="s">&quot;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">first_item</span><span class="p">))</span>

                <span class="n">first_item_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">first_item</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result_entity</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">first_item_type</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">-Heterogeneous types (</span><span class="si">%s</span><span class="s">).Expected </span><span class="si">%s</span><span class="s"> list.&#39;</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="n">entity_id</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">first_item_type</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_data_in_supported_types</span><span class="p">(</span><span class="n">result_entity</span><span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Unexpected DataType </span><span class="si">%s</span><span class="s">&quot;</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">result_entity</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__is_data_in_supported_types</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method checks if the provided data is one of the adapter supported return types </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">supported_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">supported_type</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="c">##### Data can&#39;t be mapped on any supported type !!</span>
        <span class="k">return</span> <span class="bp">False</span>
    
    
    <span class="k">def</span> <span class="nf">_is_group_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return true if this adapter is launched from a group of operations</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">operation</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_operation_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">operation_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="n">fk_operation_group</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ABCAdapter.load_entity_by_gid"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.load_entity_by_gid">[docs]</a>    <span class="k">def</span> <span class="nf">load_entity_by_gid</span><span class="p">(</span><span class="n">data_gid</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load a generic DataType, specified by GID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">datatype</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_datatype_by_gid</span><span class="p">(</span><span class="n">data_gid</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datatype</span><span class="p">,</span> <span class="n">MappedType</span><span class="p">):</span>
            <span class="n">datatype_path</span> <span class="o">=</span> <span class="n">datatype</span><span class="o">.</span><span class="n">get_storage_file_path</span><span class="p">()</span>
            <span class="n">files_update_manager</span> <span class="o">=</span> <span class="n">FilesUpdateManager</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">files_update_manager</span><span class="o">.</span><span class="n">is_file_up_to_date</span><span class="p">(</span><span class="n">datatype_path</span><span class="p">):</span>
                <span class="n">datatype</span><span class="o">.</span><span class="n">invalid</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">dao</span><span class="o">.</span><span class="n">store_entity</span><span class="p">(</span><span class="n">datatype</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">FileVersioningException</span><span class="p">(</span><span class="s">&quot;Encountered DataType with an incompatible storage or data version. &quot;</span>
                                              <span class="s">&quot;The DataType was marked as invalid.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">datatype</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ABCAdapter.build_adapter"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.build_adapter">[docs]</a>    <span class="k">def</span> <span class="nf">build_adapter</span><span class="p">(</span><span class="n">algo_group</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Having a module and a class name, create an instance of ABCAdapter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">adapter</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">algo_group</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">algo_group</span><span class="o">.</span><span class="n">classname</span><span class="p">])</span>
            <span class="n">adapter</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;adapter.&quot;</span> <span class="o">+</span> <span class="n">algo_group</span><span class="o">.</span><span class="n">classname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">algo_group</span><span class="o">.</span><span class="n">init_parameter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">algo_group</span><span class="o">.</span><span class="n">init_parameter</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">adapter_instance</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">algo_group</span><span class="o">.</span><span class="n">init_parameter</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">adapter_instance</span> <span class="o">=</span> <span class="n">adapter</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">adapter_instance</span><span class="p">,</span> <span class="n">ABCAdapter</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">IntrospectionException</span><span class="p">(</span><span class="s">&quot;Invalid data type: It should extend adapters.ABCAdapter!&quot;</span><span class="p">)</span>
            <span class="n">adapter_instance</span><span class="o">.</span><span class="n">algorithm_group</span> <span class="o">=</span> <span class="n">algo_group</span>
            <span class="k">return</span> <span class="n">adapter_instance</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">excep</span><span class="p">:</span>
            <span class="n">get_logger</span><span class="p">(</span><span class="s">&quot;ABCAdapter&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">excep</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">IntrospectionException</span><span class="p">(</span><span class="n">excep</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>


    <span class="c">####### METHODS for PROCESSING PARAMETERS start here #############################</span>
</div>
<div class="viewcode-block" id="ABCAdapter.review_operation_inputs"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.review_operation_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">review_operation_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: a list with the inputs from the parameters list that are instances of DataType,\</span>
<span class="sd">            and a dictionary with all parameters which are different than the declared defauts</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">flat_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flaten_input_interface</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_operation_inputs</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">flat_interface</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">_review_operation_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">flat_interface</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find out which of the submitted parameters are actually DataTypes and </span>
<span class="sd">        return a list holding all the dataTypes in parameters.</span>
<span class="sd">        :returns: list of dataTypes and changed parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inputs_datatypes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">changed_parameters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">field_dict</span> <span class="ow">in</span> <span class="n">flat_interface</span><span class="p">:</span>
            <span class="n">eq_flat_interface_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find_field_submitted_name</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">eq_flat_interface_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">is_datatype</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_DATATYPE</span> <span class="ow">in</span> <span class="n">field_dict</span> <span class="ow">and</span> <span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DATATYPE</span><span class="p">]:</span>
                    <span class="n">eq_datatype</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">load_entity_by_gid</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">eq_flat_interface_name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">eq_datatype</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">inputs_datatypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">eq_datatype</span><span class="p">)</span>
                        <span class="n">is_datatype</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">])</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                        <span class="n">point_separator</span> <span class="o">=</span> <span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">point_separator</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">module</span> <span class="o">=</span> <span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">][:</span><span class="n">point_separator</span><span class="p">]</span>
                            <span class="n">classname</span> <span class="o">=</span> <span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">][(</span><span class="n">point_separator</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):]</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="p">[],</span> <span class="nb">locals</span><span class="p">(),</span> <span class="nb">globals</span><span class="p">())</span>
                                <span class="n">class_entity</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;module.&quot;</span> <span class="o">+</span> <span class="n">classname</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">class_entity</span><span class="p">,</span> <span class="n">MappedType</span><span class="p">):</span>
                                    <span class="n">data_gid</span> <span class="o">=</span> <span class="n">parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]))</span>
                                    <span class="n">data_type</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">load_entity_by_gid</span><span class="p">(</span><span class="n">data_gid</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">data_type</span><span class="p">:</span>
                                        <span class="n">inputs_datatypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span>
                                        <span class="n">is_datatype</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span>
                                <span class="k">pass</span>

                <span class="k">if</span> <span class="n">is_datatype</span><span class="p">:</span>
                    <span class="n">changed_parameters</span><span class="p">[</span><span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_LABEL</span><span class="p">]]</span> <span class="o">=</span> <span class="n">inputs_datatypes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">display_name</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DEFAULT</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_dict</span>
                                    <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DEFAULT</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">str</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]])):</span>
                        <span class="n">changed_parameters</span><span class="p">[</span><span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_LABEL</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">field_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]])</span>

        <span class="k">return</span> <span class="n">inputs_datatypes</span><span class="p">,</span> <span class="n">changed_parameters</span>


<div class="viewcode-block" id="ABCAdapter.prepare_ui_inputs"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.prepare_ui_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_ui_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">validation_required</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepare the inputs received from a HTTP Post in a form that will be</span>
<span class="sd">        used by the Python adapter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">algorithm_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_tree</span><span class="p">()</span>
        <span class="n">algorithm_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">prepare_param_names</span><span class="p">(</span><span class="n">algorithm_inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_required_defaults</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">algorithm_inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_ui_inputs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">validation_required</span><span class="o">=</span><span class="n">validation_required</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">_append_required_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">algorithm_inputs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add if necessary any parameters marked as required that have a default value</span>
<span class="sd">        in the algorithm interface but were not submitted from the UI. For example in </span>
<span class="sd">        operations launched from context-menu or from data structure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">algorithm_inputs</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">algorithm_inputs</span><span class="p">:</span>
            <span class="c">## First handle this level of the tree, adding defaults where required</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_REQUIRED</span> <span class="ow">in</span> <span class="n">entry</span> <span class="ow">and</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_REQUIRED</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_DEFAULT</span> <span class="ow">in</span> <span class="n">entry</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span> <span class="o">!=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_DICT</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DEFAULT</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">algorithm_inputs</span><span class="p">:</span>
            <span class="c">## Now that first level was handled, go recursively on selected options only          </span>
            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_REQUIRED</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">)</span> <span class="ow">and</span> <span class="n">entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_REQUIRED</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]:</span>
                    <span class="c">#Only go recursive on option that was submitted</span>
                    <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">]</span> <span class="o">==</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]]:</span>
                        <span class="k">if</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span> <span class="ow">in</span> <span class="n">option</span><span class="p">:</span>
                            <span class="n">option</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_append_required_defaults</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span>
                                                                                    <span class="n">option</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">])</span>


<div class="viewcode-block" id="ABCAdapter.convert_ui_inputs"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.convert_ui_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">convert_ui_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">validation_required</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert HTTP POST parameters into Python parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwa</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">simple_select_list</span><span class="p">,</span> <span class="n">to_skip_dict_subargs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flaten_input_interface</span><span class="p">():</span>
            <span class="c">## If required attribute was submitted empty no point to continue, so just raise exception</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">validation_required</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_REQUIRED</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]</span> <span class="ow">in</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">InvalidParameterException</span><span class="p">(</span><span class="s">&quot;Parameter </span><span class="si">%s</span><span class="s"> is required for </span><span class="si">%s</span><span class="s"> but no value was submitted!&quot;</span>
                                                <span class="s">&quot;Please relaunch with valid parameters.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">],</span>
                                                                                            <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_DICT</span><span class="p">:</span>
                <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]],</span> <span class="n">taken_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__get_dictionary</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">taken_keys</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwa</span><span class="p">:</span>
                        <span class="k">del</span> <span class="n">kwa</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                    <span class="n">to_skip_dict_subargs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="c">## Dictionary subargs that were previously processed should be ignored</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]</span> <span class="ow">in</span> <span class="n">to_skip_dict_subargs</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="c">## DataType sub-attributes are not submitted with GID in their name...</span>
                <span class="n">kwa_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__find_field_submitted_name</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">],</span> <span class="bp">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">kwa_name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c">## Do not populate attributes not submitted</span>
                    <span class="k">continue</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">kwa_name</span><span class="p">]</span>
                <span class="c">## del kwargs[kwa_name] (don&#39;t remove the original param, as it is useful for retrieving op. input DTs)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_parent_not_submitted</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
                <span class="c">## Also do not populate sub-attributes from options not selected</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_ARRAY</span><span class="p">:</span>
                <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__convert_to_array</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]],</span> <span class="n">row</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MINVALUE</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MAXVALUE</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">__validate_range_for_array_input</span><span class="p">(</span><span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]],</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_LIST</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]],</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]])</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_BOOL</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]:</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_INT</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span>
                        <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">==</span> <span class="s">&#39;None&#39;</span><span class="p">):</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]])</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">if</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MINVALUE</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MAXVALUE</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__validate_range_for_value_input</span><span class="p">(</span><span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]],</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_FLOAT</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">==</span> <span class="s">&#39;&#39;</span> <span class="ow">or</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">==</span> <span class="s">&#39;None&#39;</span><span class="p">:</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]])</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
                    <span class="k">if</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MINVALUE</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MAXVALUE</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">__validate_range_for_value_input</span><span class="p">(</span><span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]],</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_STR</span><span class="p">:</span>
                <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_SELECT</span><span class="p">,</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_MULTIPLE</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_MULTIPLE</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>
                <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_SELECT</span><span class="p">:</span>
                    <span class="n">simple_select_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_UPLOAD</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span>
                <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c">## DataType parameter to be processed:</span>
                <span class="n">simple_select_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">])</span>
                <span class="n">datatype_gid</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span>
                <span class="c">## Load filtered and trimmed attribute (e.g. field is applied if specified):</span>
                <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__load_entity</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">datatype_gid</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_FIELD</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                    <span class="c">#Add entity_GID to the parameters to recognize original input</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]</span> <span class="o">+</span> <span class="s">&#39;_gid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datatype_gid</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collapse_arrays</span><span class="p">(</span><span class="n">kwa</span><span class="p">,</span> <span class="n">simple_select_list</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">__validate_range_for_value_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MINVALUE</span><span class="p">]</span> <span class="ow">or</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MAXVALUE</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="n">InvalidParameterException</span><span class="p">(</span><span class="s">&quot;Field </span><span class="si">%s</span><span class="s"> should be between </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s"> but provided value was </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MINVALUE</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MAXVALUE</span><span class="p">],</span> <span class="n">value</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">__validate_range_for_array_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">min_val</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="n">max_val</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">min_val</span> <span class="o">&lt;</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MINVALUE</span><span class="p">]</span> <span class="ow">or</span> <span class="n">max_val</span> <span class="o">&gt;</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MAXVALUE</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">InvalidParameterException</span><span class="p">(</span><span class="s">&quot;Field </span><span class="si">%s</span><span class="s"> should have values between </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s"> but provided array &quot;</span>
                                                <span class="s">&quot;contains min-max: (</span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">).&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">],</span>
                                                <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MINVALUE</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_MAXVALUE</span><span class="p">],</span>
                                                <span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>


    <span class="k">def</span> <span class="nf">__convert_to_array</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method used when the type of an input is array, to parse or read.</span>

<span class="sd">        If the user set an equation for computing a model parameter then the</span>
<span class="sd">        value of that parameter will be a dictionary which contains all the data</span>
<span class="sd">        needed for computing that parameter for each vertex from the used surface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">KEY_EQUATION</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> <span class="ow">and</span> <span class="n">KEY_FOCAL_POINTS</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">)</span> \
                <span class="ow">and</span> <span class="n">KEY_SURFACE_GID</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">input_data</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">))</span>
                <span class="c"># TODO move at a different level</span>
                <span class="n">equation_type</span> <span class="o">=</span> <span class="n">input_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DTYPE</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">equation_type</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Cannot figure out type of equation from input dictionary: </span><span class="si">%s</span><span class="s">. &quot;</span>
                                     <span class="s">&quot;Returning [].&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">,)))</span>
                    <span class="k">return</span> <span class="p">[]</span>
                <span class="n">splitted_class</span> <span class="o">=</span> <span class="n">equation_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                <span class="n">module</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">splitted_class</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">classname</span> <span class="o">=</span> <span class="n">splitted_class</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">eq_module</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">classname</span><span class="p">])</span>
                <span class="n">eq_class</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&#39;eq_module.&#39;</span> <span class="o">+</span> <span class="n">classname</span><span class="p">)</span>
                <span class="n">equation</span> <span class="o">=</span> <span class="n">eq_class</span><span class="o">.</span><span class="n">from_json</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">KEY_EQUATION</span><span class="p">])</span>
                <span class="n">focal_points</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">input_data</span><span class="p">[</span><span class="n">KEY_FOCAL_POINTS</span><span class="p">])</span>
                <span class="n">surface_gid</span> <span class="o">=</span> <span class="n">input_data</span><span class="p">[</span><span class="n">KEY_SURFACE_GID</span><span class="p">]</span>
                <span class="n">surface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_entity_by_gid</span><span class="p">(</span><span class="n">surface_gid</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">surface</span><span class="o">.</span><span class="n">compute_equation</span><span class="p">(</span><span class="n">focal_points</span><span class="p">,</span> <span class="n">equation</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">excep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&quot;The parameter &#39;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot;&#39; was ignored. None value was returned.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">excep</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">None</span>

        <span class="k">if</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_QUATIFIER</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">quantifier</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_QUATIFIER</span><span class="p">]</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="bp">None</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_DTYPE</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DTYPE</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">quantifier</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">QUANTIFIER_MANUAL</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">string2array</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">input_data</span><span class="p">),</span> <span class="s">&quot;,&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">quantifier</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">QUANTIFIER_UPLOAD</span><span class="p">:</span>
                    <span class="n">input_str</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">string2array</span><span class="p">(</span><span class="n">input_str</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">quantifier</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">QUANTIFIER_FUNTION</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">input_data</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">excep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Could not launch operation !&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">excep</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Could not launch with no data from:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]))</span>
        <span class="k">return</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">__get_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all key/value pairs for the dictionary represented by name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__is_parent_not_submitted</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{},</span> <span class="p">[]</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]</span>
        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">taken_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">key</span> <span class="ow">and</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
                <span class="n">taken_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_DTYPE</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DTYPE</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;array&#39;</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">string2array</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="s">&quot; &quot;</span><span class="p">,</span> <span class="s">&quot;float&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_DTYPE</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;(&#39;&quot;</span> <span class="o">+</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;&#39;)&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="n">result_dict</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">[</span><span class="mi">1</span><span class="p">:])[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">result_dict</span><span class="p">,</span> <span class="n">taken_keys</span>


    <span class="k">def</span> <span class="nf">__find_field_submitted_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">submited_kwargs</span><span class="p">,</span> <span class="n">flat_name</span><span class="p">,</span> <span class="n">perform_clean</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return key as in submitted dictionary for a given flat_name. Also remove from submitted_kwargs parameters like</span>
<span class="sd">        surface_parameters_option_DIFFERENT_GID_vertices.</span>
<span class="sd">        This won&#39;t work when DataType is in selectMultiple !!!!</span>
<span class="sd">        :param submited_kwargs: Flat dictionary with  keys in form surface_parameters_option_GID_vertices</span>
<span class="sd">        :param flat_name: Name as retrieved from self.flaten_input_interface</span>
<span class="sd">                         (in which we are not aware of existing entities in DB - options in select)</span>
<span class="sd">        :returns: key from &#39;submited_kwargs&#39; which corresponds to &#39;flat_name&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">flat_name</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">flat_name</span> <span class="ow">in</span> <span class="n">submited_kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">flat_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">flat_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">flat_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)]</span>
        <span class="n">sufix</span> <span class="o">=</span> <span class="n">flat_name</span><span class="p">[(</span><span class="n">flat_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">):]</span>
        <span class="n">parent_name</span> <span class="o">=</span> <span class="n">flat_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">flat_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)]</span>
        <span class="n">submitted_options</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">__compute_submit_option_select</span><span class="p">(</span><span class="n">submited_kwargs</span><span class="p">[</span><span class="n">parent_name</span><span class="p">])</span>

        <span class="n">datatype_like_submit</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">for</span> <span class="n">submitted_option</span> <span class="ow">in</span> <span class="n">submitted_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sufix</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">submitted_option</span><span class="p">)):</span>
                <span class="n">proposed_name</span> <span class="o">=</span> <span class="n">flat_name</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">datatype_like_submit</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">proposed_name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">submitted_option</span><span class="p">)</span>
                <span class="n">proposed_name</span> <span class="o">=</span> <span class="n">proposed_name</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span> <span class="o">+</span> <span class="n">sufix</span>

            <span class="k">if</span> <span class="n">perform_clean</span><span class="p">:</span>
                <span class="c">## Remove submitted parameters like surface_parameters_option_GID_vertices when surface != GID</span>
                <span class="n">keys_to_remove</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">submit_key</span> <span class="ow">in</span> <span class="n">submited_kwargs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">submit_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span><span class="p">)</span>
                            <span class="ow">and</span> <span class="n">submit_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">sufix</span><span class="p">)</span> <span class="ow">and</span> <span class="n">submit_key</span> <span class="o">!=</span> <span class="n">proposed_name</span><span class="p">):</span>
                        <span class="n">keys_to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submit_key</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">submit_key</span> <span class="ow">in</span> <span class="n">keys_to_remove</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">submited_kwargs</span><span class="p">[</span><span class="n">submit_key</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">datatype_like_submit</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">submitted_options</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;DataType attribute in SELECT_MULTIPLE is not supposed to work!!!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">proposed_name</span> <span class="ow">in</span> <span class="n">submited_kwargs</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">proposed_name</span>
        <span class="k">return</span> <span class="bp">None</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__is_parent_not_submitted</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :returns: True when current attributes should not be considered, because parent option was not selected.&quot;&quot;&quot;</span>
        <span class="n">att_name</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]</span>
        <span class="n">parent_name</span><span class="p">,</span> <span class="n">option</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span> <span class="ow">in</span> <span class="n">att_name</span><span class="p">:</span>
            <span class="n">parent_name</span> <span class="o">=</span> <span class="n">att_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">att_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)]</span>
            <span class="n">option</span> <span class="o">=</span> <span class="n">att_name</span><span class="p">[</span><span class="n">att_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">:]</span>
            <span class="n">option</span> <span class="o">=</span> <span class="n">option</span><span class="p">[:</span> <span class="n">option</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">parent_name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">option</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="n">submitted_option</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">__compute_submit_option_select</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">parent_name</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">submitted_option</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">submitted_option</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">__compute_submit_option_select</span><span class="p">(</span><span class="n">submitted_option</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">submitted_option</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
            <span class="n">submitted_option</span> <span class="o">=</span> <span class="n">submitted_option</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;[&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;]&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">submitted_option</span>


    <span class="k">def</span> <span class="nf">__load_entity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">datatype_gid</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load specific DataType entities, as specified in DATA_TYPE table. </span>
<span class="sd">        Check if the GID is for the correct DataType sub-class, otherwise throw an exception.&quot;&quot;&quot;</span>

        <span class="n">entity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_entity_by_gid</span><span class="p">(</span><span class="n">datatype_gid</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">entity</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEY_REQUIRED</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_REQUIRED</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="n">InvalidParameterException</span><span class="p">(</span><span class="s">&quot;Empty value for required parameter </span><span class="si">%s</span><span class="s"> &quot;</span> <span class="o">%</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_LABEL</span><span class="p">])</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">expected_dt_class</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_dt_class</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
            <span class="n">classname</span> <span class="o">=</span> <span class="n">expected_dt_class</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">data_class</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">expected_dt_class</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">classname</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">classname</span><span class="p">])</span>
            <span class="n">data_class</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;data_class.&quot;</span> <span class="o">+</span> <span class="n">classname</span><span class="p">)</span>
            <span class="n">expected_dt_class</span> <span class="o">=</span> <span class="n">data_class</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">expected_dt_class</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">InvalidParameterException</span><span class="p">(</span><span class="s">&quot;Expected param &#39;</span><span class="si">%s</span><span class="s">&#39; of type </span><span class="si">%s</span><span class="s">, but got type </span><span class="si">%s</span><span class="s">.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_LABEL</span><span class="p">],</span>
                                            <span class="n">expected_dt_class</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">entity</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">entity</span>

        <span class="c">## Step 2 of updating Meta-data from parent DataType.</span>
        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">fk_parent_burst</span><span class="p">:</span>
            <span class="c">## Link just towards the last Burst identified.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_BURST</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">fk_parent_burst</span>

        <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">user_tag_1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_TAG_1</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">user_tag_1</span>

        <span class="n">current_subject</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_SUBJECT</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">current_subject</span> <span class="o">==</span> <span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">DEFAULT_SUBJECT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_SUBJECT</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="o">.</span><span class="n">subject</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">entity</span><span class="o">.</span><span class="n">subject</span> <span class="o">!=</span> <span class="n">current_subject</span> <span class="ow">and</span> <span class="n">entity</span><span class="o">.</span><span class="n">subject</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current_subject</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">meta_data</span><span class="p">[</span><span class="n">DataTypeMetaData</span><span class="o">.</span><span class="n">KEY_SUBJECT</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_subject</span> <span class="o">+</span> <span class="s">&#39;,&#39;</span> <span class="o">+</span> <span class="n">entity</span><span class="o">.</span><span class="n">subject</span>
        <span class="c">##  End Step 2 - Meta-data Updates</span>

        <span class="c">## Validate current entity to be compliant with specified ROW filters.</span>
        <span class="n">dt_filter</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ELEM_CONDITIONS</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">dt_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">dt_filter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">entity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dt_filter</span><span class="o">.</span><span class="n">get_python_filter_equivalent</span><span class="p">(</span><span class="n">entity</span><span class="p">):</span>
            <span class="c">## If a filter is declared, check that the submitted DataType is in compliance to it.</span>
            <span class="k">raise</span> <span class="n">InvalidParameterException</span><span class="p">(</span><span class="s">&quot;Field </span><span class="si">%s</span><span class="s"> did not pass filters.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">],))</span>

    <span class="c"># In case a specific field in entity is to be used, use it</span>
        <span class="k">if</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_FIELD</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;entity.&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_FIELD</span><span class="p">])</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">ATT_METHOD</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">param_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="c">#The &#39;shape&#39; attribute of an arraywrapper is overridden by us</span>
            <span class="c">#the following check is made only to improve performance </span>
            <span class="c"># (to find data in the dictionary with O(1)) on else the data is found in O(n)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s">&#39;shape&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">entity</span><span class="o">.</span><span class="n">shape</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">param_key</span> <span class="o">=</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="n">ATT_PARAMETERS</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">param_key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                        <span class="n">param_dict</span><span class="p">[</span><span class="n">param_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">param_key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                  <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="n">ATT_PARAMETERS</span><span class="p">]))</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;entity.&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="n">ATT_METHOD</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;(param_dict)&quot;</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ABCAdapter.collapse_arrays"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.collapse_arrays">[docs]</a>    <span class="k">def</span> <span class="nf">collapse_arrays</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">simple_select_list</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; In case of variables with similar names:</span>
<span class="sd">        (name_parameters_[option_xx]_paramKey) collapse then into dictionary </span>
<span class="sd">        of parameters. This is used after parameters POST, on Operation Launch.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">short_name</span> <span class="o">=</span> <span class="n">name</span>
            <span class="n">option</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">key</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">short_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">11</span><span class="p">)]</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">name</span><span class="p">[(</span><span class="n">name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">):]</span>
                <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">7</span><span class="p">:]</span>     <span class="c"># Remove &#39;_option_&#39;</span>
                    <span class="n">option</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span><span class="p">)]</span>
                    <span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">key</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">short_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">short_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="n">option</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">short_name</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">option</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="n">short_name</span><span class="p">]:</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">short_name</span><span class="p">][</span><span class="n">option</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">short_name</span><span class="p">][</span><span class="n">option</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">for</span> <span class="n">level1_name</span><span class="p">,</span> <span class="n">level1_params</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">level1_name</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">level1_params</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">short_parent_name</span> <span class="o">=</span> <span class="n">level1_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">level1_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">+</span> <span class="n">short_parent_name</span><span class="p">)</span> <span class="ow">in</span> <span class="n">simple_select_list</span><span class="p">:</span>
                    <span class="c"># simple select</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">level1_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">level1_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">]],</span>
                                  <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                        <span class="n">parent_prefix</span> <span class="o">=</span> <span class="n">level1_name</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span>
                        <span class="n">parent_prefix</span> <span class="o">+=</span> <span class="n">result</span><span class="p">[</span><span class="n">level1_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">level1_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span><span class="p">]]</span>
                        <span class="n">parent_prefix</span> <span class="o">+=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span>
                        <span class="c"># Ignore options in case of simple selects</span>
                        <span class="c"># Take only attributes for current selected option.</span>
                        <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="n">short_parent_name</span><span class="p">]</span> <span class="ow">in</span> <span class="n">level1_params</span><span class="p">:</span>
                            <span class="n">level1_params</span> <span class="o">=</span> <span class="n">level1_params</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="n">short_parent_name</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">level1_params</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">parent_prefix</span> <span class="o">=</span> <span class="n">level1_name</span>

                    <span class="n">transformed_params</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">collapse_arrays</span><span class="p">(</span><span class="n">level1_params</span><span class="p">,</span> <span class="n">simple_select_list</span><span class="p">,</span>
                                                                    <span class="n">parent</span> <span class="o">+</span> <span class="n">parent_prefix</span><span class="p">)</span>
                    <span class="n">result</span><span class="p">[</span><span class="n">level1_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformed_params</span>
                <span class="k">elif</span> <span class="n">short_parent_name</span> <span class="ow">in</span> <span class="n">result</span><span class="p">:</span>
                    <span class="c"># multiple select</span>
                    <span class="k">for</span> <span class="n">level2_name</span><span class="p">,</span> <span class="n">level2_params</span> <span class="ow">in</span> <span class="n">level1_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">parent_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="n">level1_name</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span> <span class="o">+</span>
                                         <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span> <span class="o">+</span> <span class="n">level2_name</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span><span class="p">)</span>
                        <span class="n">transformed_params</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">collapse_arrays</span><span class="p">(</span><span class="n">level2_params</span><span class="p">,</span> <span class="n">simple_select_list</span><span class="p">,</span>
                                                                        <span class="n">parent</span> <span class="o">+</span> <span class="n">parent_prefix</span><span class="p">)</span>
                        <span class="n">result</span><span class="p">[</span><span class="n">level1_name</span><span class="p">][</span><span class="n">level2_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">transformed_params</span>
        <span class="k">return</span> <span class="n">result</span>

</div>
<div class="viewcode-block" id="ABCAdapter.noise_configurable_parameters"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.noise_configurable_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">noise_configurable_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">entry</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flaten_input_interface</span><span class="p">()</span> <span class="k">if</span> <span class="s">&#39;configurableNoise&#39;</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="ABCAdapter.flaten_input_interface"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.flaten_input_interface">[docs]</a>    <span class="k">def</span> <span class="nf">flaten_input_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return a simple dictionary, instead of a Tree.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flaten</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_input_tree</span><span class="p">())</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ABCAdapter.form_prefix"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.form_prefix">[docs]</a>    <span class="k">def</span> <span class="nf">form_prefix</span><span class="p">(</span><span class="n">input_param</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">option_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute parameter prefix. We need to be able from the flatten  </span>
<span class="sd">        submitted values in UI, to be able to re-compose the tree of parameters,</span>
<span class="sd">        and to make sure all submitted names are uniquely identified.&quot;&quot;&quot;</span>
        <span class="n">new_prefix</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">prefix</span>
        <span class="k">if</span> <span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">prefix</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">new_prefix</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span><span class="p">):</span>
            <span class="n">new_prefix</span> <span class="o">+=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span>
        <span class="n">new_prefix</span> <span class="o">+=</span> <span class="n">input_param</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span>
        <span class="k">if</span> <span class="n">option_prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">new_prefix</span> <span class="o">+=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span> <span class="o">+</span> <span class="n">option_prefix</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span>
        <span class="k">return</span> <span class="n">new_prefix</span>

</div>
<div class="viewcode-block" id="ABCAdapter.key_parameters"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.key_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">key_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters_for</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the keyword expected for holding parameters </span>
<span class="sd">            for argument &#39;parameters_for&#39;.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">parameters_for</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>

</div>
    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ABCAdapter.fill_defaults"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.fill_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">fill_defaults</span><span class="p">(</span><span class="n">adapter_interface</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">fill_unselected_branches</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Change the default values in the Input Interface Tree.&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">adapter_interface</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;integrator&#39;</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">new_p</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_p</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_DEFAULT</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">new_p</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">fill_defaults</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span>
                                                                            <span class="n">fill_unselected_branches</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">new_options</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="ow">in</span> <span class="n">data</span> <span class="ow">or</span> <span class="n">fill_unselected_branches</span><span class="p">:</span>
                    <span class="n">selected_values</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">TYPE_MULTIPLE</span><span class="p">:</span>
                            <span class="n">selected_values</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">selected_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]]]</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">option</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_options</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">option</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">]</span> <span class="ow">in</span> <span class="n">selected_values</span> <span class="ow">or</span> <span class="n">fill_unselected_branches</span><span class="p">:</span>
                            <span class="n">new_options</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">fill_defaults</span><span class="p">([</span><span class="n">option</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">fill_unselected_branches</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">new_p</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_options</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

</div>
    <span class="k">def</span> <span class="nf">_flaten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params_list</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Internal method, to be used recursively, on parameters POST. &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">params_list</span><span class="p">:</span>
            <span class="n">new_param</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">new_param</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">new_param</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_TYPE</span> <span class="ow">in</span> <span class="n">param</span><span class="p">):</span>
                <span class="n">new_param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_param</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_OPTIONS</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">param</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]:</span>
                    <span class="c">### SELECT or SELECT_MULTIPLE attributes</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span> <span class="ow">in</span> <span class="n">option</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                        <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">form_prefix</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">],</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">option</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">])</span>
                        <span class="n">extra_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flaten</span><span class="p">(</span><span class="n">option</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">],</span> <span class="n">new_prefix</span><span class="p">)</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_list</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="c">### DATATYPE attributes</span>
                <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">form_prefix</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">],</span> <span class="n">prefix</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">extra_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flaten</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">],</span> <span class="n">new_prefix</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">extra_list</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


    <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="ABCAdapter.prepare_param_names"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAdapter.prepare_param_names">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_param_names</span><span class="p">(</span><span class="n">attributes_list</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">add_option_prefix</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For a given attribute list, change the name of the attributes where needed.</span>
<span class="sd">        Changes refer to adding a prefix, to identify groups.</span>
<span class="sd">        Will be used on parameters page GET.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">attributes_list</span><span class="p">:</span>
            <span class="n">prepared_param</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
            <span class="n">new_name</span> <span class="o">=</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">prefix</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span> <span class="ow">in</span> <span class="n">param</span><span class="p">):</span>
                <span class="n">new_name</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span>
                <span class="n">prepared_param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>

            <span class="k">if</span> <span class="p">(((</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">or</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span> <span class="ow">in</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">STATIC_ACCEPTED_TYPES</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)):</span>
                <span class="n">add_prefix_option</span> <span class="o">=</span> <span class="p">((</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span>
                                     <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_MULTIPLE</span>
                                      <span class="ow">or</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">TYPE_SELECT</span><span class="p">))</span>
                <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">form_prefix</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">],</span> <span class="n">prefix</span><span class="p">)</span>
                <span class="n">prepared_param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">prepare_param_names</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_OPTIONS</span><span class="p">],</span>
                                                                                        <span class="n">new_prefix</span><span class="p">,</span> <span class="n">add_prefix_option</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">prefix</span>
                <span class="n">is_dict</span> <span class="o">=</span> <span class="p">(</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span> <span class="ow">in</span> <span class="n">param</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;dict&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">add_option_prefix</span><span class="p">:</span>
                    <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_OPTION</span>
                    <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">new_prefix</span> <span class="o">+</span> <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">]</span>
                    <span class="n">new_prefix</span> <span class="o">+=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_SEPARATOR</span>
                <span class="k">if</span> <span class="n">is_dict</span><span class="p">:</span>
                    <span class="n">new_prefix</span> <span class="o">=</span> <span class="n">new_name</span> <span class="o">+</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEYWORD_PARAMS</span>
                <span class="n">prepared_param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">prepare_param_names</span><span class="p">(</span>
                                                        <span class="n">param</span><span class="p">[</span><span class="n">ABCAdapter</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">],</span> <span class="n">new_prefix</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prepared_param</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


</div></div>
<div class="viewcode-block" id="ABCGroupAdapter"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter">[docs]</a><span class="k">class</span> <span class="nc">ABCGroupAdapter</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Still Abstract class.</span>
<span class="sd">    Acts as a notifier that a given adapter has a group of sub-algorithms.</span>
<span class="sd">    It is used for multiple simple methods interfaced in TVB through an XML description.</span>
<span class="sd">    &quot;&quot;&quot;</span>


    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xml_file_path</span><span class="p">):</span>
        <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">xml_file_path</span><span class="p">):</span>
            <span class="n">xml_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">CURRENT_DIR</span><span class="p">,</span> <span class="n">xml_file_path</span><span class="p">)</span>
        <span class="c">### Find the XML reader (it loads only once in the system per XML file).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span> <span class="o">=</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">XMLGroupReader</span><span class="o">.</span><span class="n">get_instance</span><span class="p">(</span><span class="n">xml_file_path</span><span class="p">)</span>


<div class="viewcode-block" id="ABCGroupAdapter.get_input_tree"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_input_tree">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Overwrite empty method from super.&quot;&quot;&quot;</span>
        <span class="n">interface_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">algorithm_group</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">interface_result</span>
        <span class="n">tree_root</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">tree_root</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_group_name</span><span class="p">()</span>
        <span class="n">tree_root</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_LABEL</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_group_label</span><span class="p">()</span>
        <span class="n">tree_root</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_REQUIRED</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">tree_root</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TYPE_SELECT</span>
        <span class="n">tree_root</span><span class="p">[</span><span class="n">ELEM_OPTIONS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_options_for_group</span><span class="p">()</span>
        <span class="n">interface_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_root</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">interface_result</span>

</div>
    <span class="k">def</span> <span class="nf">_compute_options_for_group</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sub-Algorithms&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_algorithms_dictionary</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">identifier</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">option</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">option</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="n">identifier</span>
            <span class="n">option</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithms</span><span class="p">[</span><span class="n">identifier</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_NAME</span><span class="p">]</span>
            <span class="n">algorithm</span> <span class="o">=</span> <span class="n">dao</span><span class="o">.</span><span class="n">get_algorithm_by_group</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">algorithm_group</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">identifier</span><span class="p">)</span>
            <span class="n">option</span><span class="p">[</span><span class="s">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">algorithm</span><span class="o">.</span><span class="n">description</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">algorithms</span><span class="p">[</span><span class="n">identifier</span><span class="p">][</span><span class="n">INPUTS_KEY</span><span class="p">]</span>
            <span class="n">option</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">KEY_ATTRIBUTES</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">inputs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
            <span class="n">option</span><span class="p">[</span><span class="n">ELEM_OUTPUTS</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">option</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<div class="viewcode-block" id="ABCGroupAdapter.get_input_for_algorithm"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_input_for_algorithm">[docs]</a>    <span class="k">def</span> <span class="nf">get_input_for_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm_identifier</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For a group, we will return input tree on algorithm base.&quot;&quot;&quot;</span>
        <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_inputs</span><span class="p">(</span><span class="n">algorithm_identifier</span><span class="p">)</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">form_prefix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_param</span><span class="p">(),</span> <span class="n">option_prefix</span><span class="o">=</span><span class="n">algorithm_identifier</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ABCAdapter</span><span class="o">.</span><span class="n">prepare_param_names</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">prefix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.get_output"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_output">[docs]</a>    <span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For a group, we will return outputs of all sub-algorithms.&quot;&quot;&quot;</span>
        <span class="n">real_outputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">output_description</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_all_outputs</span><span class="p">():</span>
            <span class="n">full_type</span> <span class="o">=</span> <span class="n">output_description</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">]</span>
            <span class="n">real_outputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_import_type</span><span class="p">(</span><span class="n">full_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">real_outputs</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.get_output_for_algorithm"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_output_for_algorithm">[docs]</a>    <span class="k">def</span> <span class="nf">get_output_for_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For this group, we will return input tree on algorithm base.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_outputs</span><span class="p">(</span><span class="n">algorithm_identifier</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.get_algorithms_dictionary"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_algorithms_dictionary">[docs]</a>    <span class="k">def</span> <span class="nf">get_algorithms_dictionary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of sub-algorithms in current group&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_algorithms_dictionary</span><span class="p">()</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.get_algorithm_param"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_algorithm_param">[docs]</a>    <span class="k">def</span> <span class="nf">get_algorithm_param</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This string, represents the argument name, </span>
<span class="sd">        where the algorithms selection is submitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">root_name</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.get_call_code"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_call_code">[docs]</a>    <span class="k">def</span> <span class="nf">get_call_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;From the XML interface, read the code for call method.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_code</span><span class="p">(</span><span class="n">algorithm_identifier</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.get_matlab_file"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_matlab_file">[docs]</a>    <span class="k">def</span> <span class="nf">get_matlab_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;From the XML interface read the name of the file that contains the code.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_matlab_file</span><span class="p">(</span><span class="n">algorithm_identifier</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.get_import_code"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_import_code">[docs]</a>    <span class="k">def</span> <span class="nf">get_import_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm_identifier</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;From the XML interface, read the code for Python import. Optional&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">get_import</span><span class="p">(</span><span class="n">algorithm_identifier</span><span class="p">)</span>

</div>
    <span class="k">def</span> <span class="nf">_import_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">full_type_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute a dynamic import and return class reverence&quot;&quot;&quot;</span>
        <span class="n">module</span> <span class="o">=</span> <span class="n">full_type_string</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span> <span class="n">full_type_string</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)]</span>
        <span class="n">class_name</span> <span class="o">=</span> <span class="n">full_type_string</span><span class="p">[</span><span class="n">full_type_string</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[</span><span class="n">class_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Imported: &quot;</span> <span class="o">+</span> <span class="n">reference</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">eval</span><span class="p">(</span><span class="s">&quot;reference.&quot;</span> <span class="o">+</span> <span class="n">class_name</span><span class="p">)</span>


<div class="viewcode-block" id="ABCGroupAdapter.build_result"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.build_result">[docs]</a>    <span class="k">def</span> <span class="nf">build_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build an actual Python object, based on the XML interface description.</span>
<span class="sd">        Put inside the resulting Python object, the call result. </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">final_result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received results:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;Received inputs:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">inputs</span><span class="p">))</span>
        <span class="n">python_out_references</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_output_for_algorithm</span><span class="p">(</span><span class="n">algorithm</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">python_out_references</span><span class="p">:</span>
            <span class="c"># First prepare output attributes</span>
            <span class="n">kwa</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">output</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ELEM_FIELD</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_VALUE</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_VALUE</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_REFERENCE</span><span class="p">]</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="p">,</span> <span class="s">&#39;result[&#39;</span><span class="p">)</span>
                    <span class="n">expression</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">,</span> <span class="s">&#39;]&#39;</span><span class="p">)</span>
                    <span class="n">kwa</span><span class="p">[</span><span class="n">field</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_NAME</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
            <span class="n">kwa</span><span class="p">[</span><span class="s">&quot;storage_path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage_path</span>
            <span class="c"># Import Output type and call constructor</span>
            <span class="n">out_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_import_type</span><span class="p">(</span><span class="n">output</span><span class="p">[</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">ATT_TYPE</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Executing INIT with parameters:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwa</span><span class="p">))</span>
            <span class="n">final_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_class</span><span class="p">(</span><span class="o">**</span><span class="n">kwa</span><span class="p">))</span>
        <span class="n">final_result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">final_result</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.get_algorithm_and_attributes"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.get_algorithm_and_attributes">[docs]</a>    <span class="k">def</span> <span class="nf">get_algorithm_and_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Read selected Algorithm identifier, from input arguments.</span>
<span class="sd">        From the original full dictionary, split Algorithm name, </span>
<span class="sd">        and actual algorithms arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">algorithm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">root_name</span><span class="p">]</span>
        <span class="n">key_real_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">key_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xml_reader</span><span class="o">.</span><span class="n">root_name</span><span class="p">)</span>
        <span class="n">algorithm_arguments</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">key_real_args</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">algorithm_arguments</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key_real_args</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">algorithm_arguments</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.prepare_ui_inputs"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.prepare_ui_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_ui_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">validation_required</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overwrite the method from ABCAdapter to only append the required defaults for</span>
<span class="sd">        the selected subalgorithm.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">algorithm_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_param</span><span class="p">()</span>
        <span class="n">algorithm_inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_for_algorithm</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="n">algorithm_name</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_append_required_defaults</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">algorithm_inputs</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_ui_inputs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">validation_required</span><span class="o">=</span><span class="n">validation_required</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="ABCGroupAdapter.review_operation_inputs"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCGroupAdapter.review_operation_inputs">[docs]</a>    <span class="k">def</span> <span class="nf">review_operation_inputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list with the inputs from the parameters list that are instances of DataType.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">algorithm_name</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_algorithm_param</span><span class="p">()]</span>
        <span class="n">flat_interface</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_input_for_algorithm</span><span class="p">(</span><span class="n">algorithm_name</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_review_operation_inputs</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">flat_interface</span><span class="p">)</span>


</div></div>
<div class="viewcode-block" id="ABCAsynchronous"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCAsynchronous">[docs]</a><span class="k">class</span> <span class="nc">ABCAsynchronous</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Abstract class, for marking adapters that are prone to be executed </span>
<span class="sd">      on Cluster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>


</div>
<div class="viewcode-block" id="ABCSynchronous"><a class="viewcode-back" href="../../../../tvb.core.adapters.html#tvb.core.adapters.abcadapter.ABCSynchronous">[docs]</a><span class="k">class</span> <span class="nc">ABCSynchronous</span><span class="p">(</span><span class="n">ABCAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">      Abstract class, for marking adapters that are prone to be NOT executed </span>
<span class="sd">      on Cluster.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>
    
</pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../../../index.html">
              <img class="logo" src="../../../../_static/evil_tvb_logo_transparent.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">The Virtual Brain 1.1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2b1.
    </div>
  </body>
</html>