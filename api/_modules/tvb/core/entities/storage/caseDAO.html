

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.core.entities.storage.caseDAO &mdash; The Virtual Brain 1.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '1.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Virtual Brain 1.0.4 documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.core.entities.storage.caseDAO</h1><pre>
# -*- coding: utf-8 -*-
#
#
# TheVirtualBrain-Framework Package. This package holds all Data Management, and 
# Web-UI helpful to run brain-simulations. To use it, you also need do download
# TheVirtualBrain-Scientific Package (for simulators). See content of the
# documentation-folder for more details. See also http://www.thevirtualbrain.org
#
# (c) 2012-2013, Baycrest Centre for Geriatric Care ("Baycrest")
#
# This program is free software; you can redistribute it and/or modify it under 
# the terms of the GNU General Public License version 2 as published by the Free
# Software Foundation. This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
# License for more details. You should have received a copy of the GNU General 
# Public License along with this program; if not, you can download it here
# http://www.gnu.org/licenses/old-licenses/gpl-2.0
#
#

"""
DAO operation related to Users and Projects are defined here.

.. moduleauthor:: Lia Domide &lt;lia.domide@codemart.ro&gt;
.. moduleauthor:: Bogdan Neacsa &lt;bogdan.neacsa@codemart.ro&gt;
"""

from sqlalchemy import or_, and_
from sqlalchemy.sql.expression import desc
from sqlalchemy.orm.exc import NoResultFound
from tvb.basic.config.settings import TVBSettings as cfg
from tvb.core.entities import model
from tvb.core.entities.storage.rootDAO import RootDAO



<div class="viewcode-block" id="CaseDAO"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO">[docs]</a>class CaseDAO(RootDAO):
    """
    USER and PROJECT RELATED OPERATIONS
    """
    
<div class="viewcode-block" id="CaseDAO.get_user_by_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_user_by_id">[docs]</a>    def get_user_by_id(self, user_id):
        """Retrieve USER entity by name."""
        user = None
        try:
            user = self.session.query(model.User).filter_by(id=user_id).one()
        except Exception, _:
            user = None
        return user
    
        </div>
<div class="viewcode-block" id="CaseDAO.get_user_by_name"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_user_by_name">[docs]</a>    def get_user_by_name(self, name):
        """Retrieve USER entity by name."""
        user = None
        try:
            user = self.session.query(model.User).filter_by(username=name).one()
        except Exception, _:
            user = None
        return user
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_system_user"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_system_user">[docs]</a>    def get_system_user(self,):
        """Retrieve System user by name."""
        user = None
        try:
            user = self.session.query(model.User).filter_by(username=
                                                       cfg.SYSTEM_USER_NAME).one()
        except Exception, _:
            user = None
        return user    
    
        </div>
<div class="viewcode-block" id="CaseDAO.count_users_for_name"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.count_users_for_name">[docs]</a>    def count_users_for_name(self, name):
        """Retrieve the number of users in DB for a given name."""
        result = self.session.query(model.User).filter_by(username=name).count()
        return result
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_administrators"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_administrators">[docs]</a>    def get_administrators(self,):
        """Retrieve System user by name."""
        admins = None
        try:
            admins = self.session.query(model.User).filter_by(
                                            role=model.ROLE_ADMINISTRATOR).all()
        except Exception, _:
            admins = None
        return admins 
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_all_users"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_all_users">[docs]</a>    def get_all_users(self, different_name = ' ', page_start = 0, page_end = 20, is_count = False):
        """Retrieve all USERS in DB, except current user and system user."""
        try:
            query = self.session.query(model.User
                                ).filter(model.User.username !=different_name
                                ).filter(model.User.username !=cfg.SYSTEM_USER_NAME)
            if is_count:
                result = query.count()
            else:               
                result = query.offset(max(page_start, 0)).limit(max(page_end, 0)).all()
            return result
        except NoResultFound:
            self.logger.warning("No users found. Maybe database is empty.")
            raise 
        
    </div>
<div class="viewcode-block" id="CaseDAO.get_user_by_name_email"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_user_by_name_email">[docs]</a>    def get_user_by_name_email(self, username, email):
        """For a username and a email reset the password to a random one"""
        user = None
        try:
            user = self.session.query(model.User).filter_by(username=username,
                                                            email=email).one()
        except Exception, _:
            user = None
        return user
    
    </div>
<div class="viewcode-block" id="CaseDAO.delete_user"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.delete_user">[docs]</a>    def delete_user(self, user_id):
        """Remove USER entity by ID."""
        user = self.session.query(model.User).filter_by(id=user_id).one()
        self.session.delete(user)
        self.session.commit()
        
    </div>
<div class="viewcode-block" id="CaseDAO.get_user_for_datatype"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_user_for_datatype">[docs]</a>    def get_user_for_datatype(self, dt_id):
        """Get the user for the datatype id"""
        try:
            datatype = self.session.query(model.DataType).filter_by(id=dt_id).one()
            datatype.parent_operation
            user = datatype.parent_operation.user
        except Exception, ex:
            self.logger.exception(ex)
            user = None
        return user
     
            
    #
    # PROJECT RELATED OPERATIONS
    #
    </div>
<div class="viewcode-block" id="CaseDAO.get_project_by_id"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_project_by_id">[docs]</a>    def get_project_by_id(self, project_id):
        """Retrieve PROJECT entity for a given identifier.
           THROW SqlException when not found."""
        prj = self.session.query(model.Project).filter_by(id=project_id).one()
        prj.administrator
        return prj
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_project_by_gid"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_project_by_gid">[docs]</a>    def get_project_by_gid(self, project_gid):
        """Retrieve PROJECT entity for a given identifier.
           THROW SqlException when not found."""
        prj = self.session.query(model.Project).filter_by(gid=project_gid).one()
        prj.administrator
        return prj
    
    </div>
<div class="viewcode-block" id="CaseDAO.delete_project"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.delete_project">[docs]</a>    def delete_project(self, project_id):
        """Remove PROJECT entity by ID."""
        project = self.session.query(model.Project).filter_by(id=project_id).one()
        self.session.delete(project)
        linked_users = self.session.query(model.User
                                          ).filter_by(selected_project=project_id).all()
        for user in linked_users:
            user.selected_project = None
        self.session.commit()
        
        </div>
<div class="viewcode-block" id="CaseDAO.count_projects_for_name"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.count_projects_for_name">[docs]</a>    def count_projects_for_name(self, name, different_id):
        """Retrieve the number of projects with a given name currently in DB."""
        if different_id is not None:
            number = self.session.query(model.Project).filter_by(name=name).filter(
                                        model.Project.id!=different_id).count()  
        else:
            number = self.session.query(model.Project).filter_by(name=name).count()  
        return number
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_all_projects"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_all_projects">[docs]</a>    def get_all_projects(self, page_start = 0, page_end = 20, is_count = False):
        """
        Retrieve all Project entities currently in the system.
        WARNING: use this wisely, as it might easily overflow the system.
        """
        query = self.session.query(model.Project)
        if is_count:
            result = query.count()
        else:
            result = query.offset(max(page_start, 0)).limit(max(page_end, 0)).all()
        return result
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_projects_for_user"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_projects_for_user">[docs]</a>    def get_projects_for_user(self, user_id, page_start = 0, page_end = 20, is_count = False):
        """
        Return all projects a given user can access (administrator or not).
        """
        # First load projects that current user is administrator for.
        query = self.session.query(model.Project).join((model.User, model.Project.fk_admin==model.User.id)
                                ).outerjoin((model.User_to_Project, 
                                             and_(model.Project.id== model.User_to_Project.fk_project,
                                                  model.User_to_Project.fk_user==user_id))
                                ).filter(or_(model.User.id==user_id, model.User_to_Project.fk_user==user_id)
                                ).order_by(desc(model.Project.id))
        if is_count:
            result = query.count()
        else:
            result = query.offset(max(page_start, 0)).limit(max(page_end, 0)).all()
            [project.administrator.username for project in result]
        return result
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_project_for_operation"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_project_for_operation">[docs]</a>    def get_project_for_operation(self, operation_id):
        """
        Find parent project for current operation.
        """
        try:
            result = self.session.query(model.Project
                                           ).filter(model.Operation.fk_launched_in==model.Project.id
                                           ).filter(model.Operation.id==operation_id).one()
            return result
        except Exception, excep:
            self.logger.exception(excep)
            return None
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_link"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_link">[docs]</a>    def get_link(self, dt_id, project_id):
        """
        Return the link from datatype given by dt_id and project given by project_id.
        """
        result = self.session.query(model.Links).filter(model.Links.fk_from_datatype==dt_id
                                               ).filter(model.Links.fk_to_project==project_id).one()
        return result
    
    </div>
<div class="viewcode-block" id="CaseDAO.remove_link"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.remove_link">[docs]</a>    def remove_link(self, link):
        """Remove a link entity."""
        self.session.delete(link)
        self.session.commit()
        
        </div>
<div class="viewcode-block" id="CaseDAO.get_linkable_projects_for_user"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_linkable_projects_for_user">[docs]</a>    def get_linkable_projects_for_user(self, user_id, data_id):
        """
        Return all projects a given user can link some data given by a data_id to.
        """
        try:
            # First load projects that current user is administrator for.
            result = self.session.query(model.Project).join(model.User
                                  ).filter(model.User.id==user_id).order_by(model.Project.id).all()
            result.extend(self.session.query(model.Project).join(model.User_to_Project
                                        ).filter(model.User_to_Project.fk_user==user_id).all())
            linked_project_ids = self.session.query(model.Links.fk_to_project
                                               ).filter(model.Links.fk_from_datatype==data_id).all()
            linked_project_ids = [i[0] for i in linked_project_ids]
            datatype = self.get_datatype_by_id(data_id)
            current_prj = self.session.query(model.Operation.fk_launched_in
                                        ).filter(model.Operation.id==datatype.fk_from_operation).one()
            if linked_project_ids:
                linked_project_ids.append(current_prj[0])
            else:
                linked_project_ids = [current_prj[0]]
            filtered_result = [entry for entry in result if entry.id not in linked_project_ids]
            [project.administrator.username for project in filtered_result]
            linked_project_ids.remove(current_prj[0])
            linked_projects = [entry for entry in result if entry.id in linked_project_ids]
            return filtered_result, linked_projects
        except Exception, excep:
            self.logger.exception(excep)
            return None, None
    
    </div>
<div class="viewcode-block" id="CaseDAO.delete_members_for_project"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.delete_members_for_project">[docs]</a>    def delete_members_for_project(self, project_id, members):
        """Remove all linked user to current project."""
        members = self.session.query(model.User_to_Project
                                    ).filter(model.User_to_Project.fk_project==project_id
                                    ).filter(model.User_to_Project.fk_user.in_(members)
                                    ).all()
        [self.session.delete(m) for m in members]
        self.session.commit()
        
      </div>
<div class="viewcode-block" id="CaseDAO.get_members_of_project"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_members_of_project">[docs]</a>    def get_members_of_project(self, proj_id):
        """Retrieve USER entities with rights on current project."""
        users_members = self.session.query(model.User).join(model.User_to_Project
                                        ).filter(model.User_to_Project.fk_project==proj_id).all()
        return users_members 
    
    </div>
<div class="viewcode-block" id="CaseDAO.get_operation_numbers"><a class="viewcode-back" href="../../../../../tvb.core.entities.storage.html#tvb.core.entities.storage.caseDAO.CaseDAO.get_operation_numbers">[docs]</a>    def get_operation_numbers(self, proj_id):
        """
        Count total number of operations started for current project.
        """
        fns = self.session.query(model.Operation).filter_by(fk_launched_in=proj_id
                                                    ).filter_by(status=model.STATUS_FINISHED).count()
        sta = self.session.query(model.Operation).filter_by(fk_launched_in=proj_id
                                                    ).filter_by(status=model.STATUS_STARTED).count()
        err = self.session.query(model.Operation).filter_by(fk_launched_in=proj_id
                                                    ).filter_by(status=model.STATUS_ERROR).count()
        canceled = self.session.query(model.Operation).filter_by(fk_launched_in=proj_id
                                                     ).filter_by(status=model.STATUS_CANCELED).count()
        return fns, sta, err, canceled</div></div>
</pre>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>