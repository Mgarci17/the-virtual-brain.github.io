

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.core.entities.transient.structure_entities &mdash; The Virtual Brain 1.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../../',
        VERSION:     '1.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Virtual Brain 1.0.4 documentation" href="../../../../../index.html" />
    <link rel="up" title="Module code" href="../../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.core.entities.transient.structure_entities</h1><pre>
# -*- coding: utf-8 -*-
#
#
# TheVirtualBrain-Framework Package. This package holds all Data Management, and 
# Web-UI helpful to run brain-simulations. To use it, you also need do download
# TheVirtualBrain-Scientific Package (for simulators). See content of the
# documentation-folder for more details. See also http://www.thevirtualbrain.org
#
# (c) 2012-2013, Baycrest Centre for Geriatric Care ("Baycrest")
#
# This program is free software; you can redistribute it and/or modify it under 
# the terms of the GNU General Public License version 2 as published by the Free
# Software Foundation. This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
# License for more details. You should have received a copy of the GNU General 
# Public License along with this program; if not, you can download it here
# http://www.gnu.org/licenses/old-licenses/gpl-2.0
#
#

"""
.. moduleauthor:: Ionel Ortelecan &lt;ionel.ortelecan@codemart.ro&gt;
.. moduleauthor:: Lia Domide &lt;lia.domide@codemart.ro&gt;
"""

import json
from tvb.basic.config.settings import EnhancedDictionary



<div class="viewcode-block" id="StructureNode"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.StructureNode">[docs]</a>class StructureNode:
    """
    This entity represents a node in the Tree of a Project related Structure.
    """
    TYPE_FOLDER = "Folder"
    TYPE_FILE = "File"
    TYPE_INVALID = "Invalid"
    
    PREFIX_ID_NODE = "node_"
    PREFIX_ID_LEAF = "leaf_"
    PREFIX_ID_PROJECT = "projectID"
    
    SEP = "__"
    
    JSTREE_DUMMY_LEAF = "do_not_show_dummy__node"
    
    
    def __init__(self, nid, node_name, ntype = TYPE_FOLDER, meta = None, children= None):
        """
        Constructor 
        
        :param nid: Node Identifier (needs to be UQ)
        :param node_name: Node Display Name 
        :param ntype: Node Type (influences the display mode in UI).
        :param meta: DataTypeMetaData instance.
        :param children: List of StructureNode entities or None.
          
        """
        self.id = nid
        self.name = node_name
        self._type = ntype
        self.metadata = meta
        self.children = children

        
    @property
<div class="viewcode-block" id="StructureNode.has_children"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.StructureNode.has_children">[docs]</a>    def has_children(self):
        """
        Return TRUE when current node is with Child nodes.
        Return FALSE when current node is a leaf in Tree.
        """
        return self.children and len(self.children) &gt; 0
    </div>
    @property
<div class="viewcode-block" id="StructureNode.is_link"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.StructureNode.is_link">[docs]</a>    def is_link(self):
        """
        Check if meta_data has the transient is_link attribute set.
        """
        return (self.metadata is not None 
                and DataTypeMetaData.KEY_LINK in self.metadata and
                self.metadata[DataTypeMetaData.KEY_LINK] &gt; 0)
        </div>
    @property
<div class="viewcode-block" id="StructureNode.is_irelevant"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.StructureNode.is_irelevant">[docs]</a>    def is_irelevant(self):
        """Check that current node is marked as not-relevant."""
        if (self.metadata is not None and  DataTypeMetaData.KEY_RELEVANCY in 
            self.metadata and self.metadata[DataTypeMetaData.KEY_RELEVANCY]==False):
            return True
        return False
        </div>
    @property
<div class="viewcode-block" id="StructureNode.is_group"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.StructureNode.is_group">[docs]</a>    def is_group(self):
        """
        Check if meta_data has the transient is_link attribute set.
        """
        return (self.metadata is not None 
                and DataTypeMetaData.KEY_OP_GROUP_ID in self.metadata and
                self.metadata[DataTypeMetaData.KEY_OP_GROUP_ID] is not None)
    </div>
    @property
<div class="viewcode-block" id="StructureNode.type"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.StructureNode.type">[docs]</a>    def type(self):
        """
        Type of a node it can be FOLDER, FILE or INVALID.
        """
        return self._type
    
    </div>
    @staticmethod
<div class="viewcode-block" id="StructureNode.metadata2tree"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.StructureNode.metadata2tree">[docs]</a>    def metadata2tree(metadatas, first_level, second_level, project_id, project_name):
        """ 
        Take a list of DataTypeMetaData entities as input.
        Create a tree of StructureNode entities, then convert it in JSON to display in UI.

        first_level and second_level represents the fields by which
        should be structured the tree. Those fields should exists
        into the data dict of each DataTypeMetaData object.
        """
        levels = {}
        for meta in metadatas:
            level_one = str(meta[first_level])
            level_two = str(meta[second_level])
            if level_one not in levels:
                levels[level_one] = {level_two:[meta]}
            else:
                existent_sublevels = levels[level_one]
                if level_two not in existent_sublevels:
                    levels[level_one][level_two] = [meta]
                else:
                    levels[level_one][level_two].append(meta)

        forest = []
        for level in sorted(levels.iterkeys()):
            sublevels = levels[level]
            level_children = []
            for sublevel in sorted(sublevels.iterkeys()):
                metas = sublevels[sublevel]
                datas = []
                for meta in metas:
                    parent_name = meta[meta.KEY_NODE_TYPE] + " "

                    if meta[meta.KEY_TAG_1]:
                        parent_name = parent_name + " - " + meta[meta.KEY_TAG_1]
                    if meta[meta.KEY_OPERATION_TAG]:
                        parent_name = parent_name + " - " + meta[meta.KEY_OPERATION_TAG]
                    
                    parent = StructureNode(meta.gid, parent_name, meta=meta)
                    if meta.invalid:
                        parent._type = StructureNode.TYPE_INVALID
                    else:
                        parent._type = meta[meta.KEY_NODE_TYPE]
                    datas.append(parent)
                sublevel_id = level.replace(" ","") + StructureNode.SEP + sublevel.replace(" ","")
                sublevel_name = StructureNode._prepare_node_name(sublevel, second_level)
                sublevel_node = StructureNode(sublevel_id, sublevel_name, children= datas)
                sublevel_node._type = StructureNode._capitalize_first_letter(second_level)
                level_children.append(sublevel_node)
                
            dir_name = StructureNode._prepare_node_name(level, first_level)
            level_node = StructureNode(level, dir_name, children=level_children)
            level_node._type = StructureNode._capitalize_first_letter(first_level)
            forest.append(level_node)
            
        json_children = StructureNode.__convert2json(forest, project_id)
        if len(json_children) &gt; 0:
            result = '{data: [{ data: {title: "' + project_name + '"'
            result = result + ',icon: "/static/style/nodes/nodeRoot.png"},'
            result = result + 'state:"open", attr:{id:"' + StructureNode.PREFIX_ID_PROJECT
            result = result + '"}, children: [' + json_children + '] } ] }'
        else:
            result = '{data: [{ data: {title: "' + project_name + '"'
            result = result + ',icon: "/static/style/nodes/nodeRoot.png"}'
            result = result + ',attr:{id:"' + StructureNode.PREFIX_ID_PROJECT + '"}}]}'
            
        return result

</div>
    @staticmethod
    def _prepare_node_name(name, level_filter):
        """
        Process name. In case filter corresponds to STATE, then return display value for it.
        """
        if level_filter == DataTypeMetaData.KEY_STATE:
            return DataTypeMetaData.STATES[name]
        return name


    @staticmethod
    def _capitalize_first_letter(word):
        """
        :return same string, but with first letter capitalized.
        """
        return word[0].upper() + word[1:]
    
    
    @staticmethod
    def __convert2json(nodes_list, project_id):
        """
        Local method, for converting an internal Tree structure (of StructureNode entities)
        into a JSON object, ready for display into UI with JSTree.
        """
        result = ""
        place_comma = False
        for node in nodes_list:
            json_node = '{data: {title:"' + (node.name if len(node.name) &lt; 100 else node.name[:95] + "...")
            json_node = json_node + '",icon: "/static/style/nodes/node'
            if node.is_group:
                json_node = json_node + 'Group.png"},'
            else:
                json_node = json_node + node.type +'.png"},'
            if (node.metadata is None and node.has_children):
                json_node = json_node + ' state:"open", '
            if node.metadata:
                json_node = json_node + ' state:"closed", '
            json_node = (json_node + 'attr:{id:"' + StructureNode.PREFIX_ID_NODE + 
                         node.id + '"')
            json_node = json_node + ', separator: "&gt;&gt;", projectId:"' 
            json_node = json_node + str(project_id) + '"'
            if node.metadata is not None:
                meta_str = json.dumps(node.metadata)
                meta_str = meta_str.replace('{','').replace('}', '')
                json_node = json_node + ',' + meta_str
                
            json_node = json_node + ', style: "'    
            if node.is_irelevant:
                json_node = json_node + 'background-color: #666;'
            if node.is_link:
                json_node = json_node + 'font-style: italic;'
            json_node = json_node + '" }'
            
            if node.has_children:
                json_node = json_node + ', children:[' 
                json_node = json_node + StructureNode.__convert2json(node.children, project_id)+']'
            else:
                if node.metadata is not None:
                    json_node = json_node + ', children: [{data: "'
                    json_node = json_node + StructureNode.JSTREE_DUMMY_LEAF + '"}]'
            json_node = json_node + '}'
            if place_comma:
                result = result + ','
            place_comma = True
            result = result + json_node
        return result  




</div>
<div class="viewcode-block" id="GenericMetaData"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.GenericMetaData">[docs]</a>class GenericMetaData(EnhancedDictionary):
    """
    Wrap a dictionary of meta-data for generic entities 
    - Operations, Project, or DataType.
    """
    KEY_GID = "Gid"
    KEY_FILENAME = "file_name"
    
    
    def __init__(self, data=None):
        """
        :param data: THe actual dictionary to be wrapped by current entity. 
        """
        if data is not None:
            self.update(data)
        
    @property
<div class="viewcode-block" id="GenericMetaData.gid"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.GenericMetaData.gid">[docs]</a>    def gid(self):
        """
        :return: current Global Identifier or None.
        """
        if self.KEY_GID in self.keys():
            return self[self.KEY_GID]
        return None
    </div>
    @property
<div class="viewcode-block" id="GenericMetaData.file_name"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.GenericMetaData.file_name">[docs]</a>    def file_name(self):
        """
        :return: name of the file where to store current data, or None.
        """
        if self.KEY_FILENAME in self.keys():
            return self[self.KEY_FILENAME]
        return None


    </div></div>
<div class="viewcode-block" id="DataTypeMetaData"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.DataTypeMetaData">[docs]</a>class DataTypeMetaData(GenericMetaData):
    """
    This object will be populated from meta-data stored on a particular DataType/Operation.
    It should contain enough information, to restore a DataType entity, without DB previous data required.
    """
    KEY_STATE = "Data_State"
    STATES = {'RAW_DATA': 'Raw Data',
              'INTERMEDIATE': 'Intermediate',
              'FINAL': 'Final'}
    KEY_SUBJECT = "Data_Subject"
    DEFAULT_SUBJECT = "John Doe"
    KEY_BURST = "Burst_Reference"
    KEY_TAG_1 = "User_Tag_1_Perpetuated"
    KEY_TAG_2 = "User_Tag_2"
    KEY_TAG_3 = "User_Tag_3"
    KEY_TAG_4 = "User_Tag_4"
    KEY_TAG_5 = "User_Tag_5"
    KEY_MODULE = "Module"
    KEY_CLASS_NAME = "Type"
    KEY_AUTHOR = "Source_Author"
    KEY_OPERATION_TYPE = "Source_Operation_Category"
    KEY_DATE = "Creation_Date"
    KEY_OPERATION_TAG = "user_group"
    KEY_OP_GROUP_ID = "groupId"
    KEY_RELEVANCY = "Relevant"
    KEY_TITLE = "title"

    #Transient attributes
    KEY_NODE_TYPE = "DataType"
    KEY_DATATYPE_ID = "Datatypeid"
    KEY_INVALID = "datatype_invalid"
    KEY_COUNT = "count"
    KEY_LINK = "link"
    KEY_CREATE_DATA_MONTH = "createDataMonth"
    KEY_CREATE_DATA_DAY = "createDataDay"
    
    #operation details
    KEY_OPERATION_GROUP_NAME = "op_group_name"
    KEY_OPERATION_ALGORITHM = "Operation_Algorithm"
    KEY_FK_OPERATION_GROUP = 'fk_operation_group'

    
    def __init__(self, data= None, invalid= False):
        GenericMetaData.__init__(self, data)
        self.invalid = invalid
        
    @property
<div class="viewcode-block" id="DataTypeMetaData.subject"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.DataTypeMetaData.subject">[docs]</a>    def subject(self):
        """
        Return the name of the Subject if defined, or Default "John Doe".
        """
        if self.KEY_SUBJECT not in self.keys():
            return self.DEFAULT_SUBJECT
        return self[self.KEY_SUBJECT]
    </div>
    @property
<div class="viewcode-block" id="DataTypeMetaData.create_date"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.DataTypeMetaData.create_date">[docs]</a>    def create_date(self):
        """
        Return the create date of this entity, if stored, or None otherwise.
        """
        if self.KEY_DATE in self.keys():
            return self[self.KEY_DATE]
        return None
    </div>
    @property
<div class="viewcode-block" id="DataTypeMetaData.group"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.DataTypeMetaData.group">[docs]</a>    def group(self):
        """
        Return the group tag in which the operation was launched
        """
        if(self.KEY_OPERATION_TAG in self.keys()):
            return self[self.KEY_OPERATION_TAG]
        return None
    </div>
<div class="viewcode-block" id="DataTypeMetaData.mark_invalid"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.DataTypeMetaData.mark_invalid">[docs]</a>    def mark_invalid(self):
        """ 
        Mark current meta-data as invalid.
        e.g. Because of a missing associated file.
        """
        self.invalid = True
        </div>
<div class="viewcode-block" id="DataTypeMetaData.merge_data"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.DataTypeMetaData.merge_data">[docs]</a>    def merge_data(self, new_data):
        """
        Update current state, from an external dictionary.
        """
        if new_data is None:
            return
        for val in new_data:
            #Ignore transient entities
            if val != self.KEY_COUNT and val != self.KEY_OP_GROUP_ID:
                self[val] = new_data[val] 
               
               
    #####   CLASS METHODS start Here ########################################
    </div>
    @classmethod
<div class="viewcode-block" id="DataTypeMetaData.get_filterable_meta"><a class="viewcode-back" href="../../../../../tvb.core.entities.transient.html#tvb.core.entities.transient.structure_entities.DataTypeMetaData.get_filterable_meta">[docs]</a>    def get_filterable_meta(cls):
        """
        Contains all the attributes by which the user can structure the tree of DataTypes.
    
        All the returned attributes should exists into the 'data' field of its 
        corresponding DataTypeMetaData object.
        """
        return [
                {cls.KEY_NODE_TYPE: "Data Type"},
                {cls.KEY_SUBJECT: "Subject"},
                {cls.KEY_STATE: "State"},
                {cls.KEY_OPERATION_TAG: "Operation group name"},
                {cls.KEY_GID: "Unique Global Identifier"},
                {cls.KEY_DATATYPE_ID: "Entity id"},
                {cls.KEY_CREATE_DATA_DAY: "Create data day"},
                {cls.KEY_CREATE_DATA_MONTH: "Create data month"},
                {cls.KEY_OPERATION_ALGORITHM: "Operation algorithm"},
                {cls.KEY_BURST: "Simulation name"},
                {cls.KEY_TAG_1: "DataType Tag 1"},
                {cls.KEY_TAG_2: "DataType Tag 2"},
                {cls.KEY_TAG_3: "DataType Tag 3"},
                {cls.KEY_TAG_4: "DataType Tag 4"},
                {cls.KEY_TAG_5: "DataType Tag 5"}
                ]


</div></div>
</pre>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>