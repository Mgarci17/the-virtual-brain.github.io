

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>tvb.core.services.userservice &mdash; The Virtual Brain 1.0.4 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '1.0.4',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Virtual Brain 1.0.4 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for tvb.core.services.userservice</h1><pre>
# -*- coding: utf-8 -*-
#
#
# TheVirtualBrain-Framework Package. This package holds all Data Management, and 
# Web-UI helpful to run brain-simulations. To use it, you also need do download
# TheVirtualBrain-Scientific Package (for simulators). See content of the
# documentation-folder for more details. See also http://www.thevirtualbrain.org
#
# (c) 2012-2013, Baycrest Centre for Geriatric Care ("Baycrest")
#
# This program is free software; you can redistribute it and/or modify it under 
# the terms of the GNU General Public License version 2 as published by the Free
# Software Foundation. This program is distributed in the hope that it will be
# useful, but WITHOUT ANY WARRANTY; without even the implied warranty of 
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public
# License for more details. You should have received a copy of the GNU General 
# Public License along with this program; if not, you can download it here
# http://www.gnu.org/licenses/old-licenses/gpl-2.0
#
#

"""
Service layer for USER entities. 
   
.. moduleauthor:: Lia Domide &lt;lia.domide@codemart.ro&gt;
"""
import threading
from random import randint
from hashlib import md5
from inspect import stack
from tvb.basic.config.settings import TVBSettings as cfg
from tvb.basic.logger.builder import get_logger
from tvb.core.utils import synchronized
from tvb.core.entities import model 
from tvb.core.entities.storage import dao
from tvb.core.entities.file.filesupdatemanager import FilesUpdateManager
from tvb.core.entities.file.exceptions import FileVersioningException
from tvb.core.services import sendmail
from tvb.core.services.exceptions import UsernameException
from tvb.core.services.settingsservice import SettingsService
import tvb.core.services.eventhandler as eventhandler


FROM_ADDRESS = 'donotreply@thevirtualbrain.org'
SUBJECT_REGISTER = '[TVB] Registration Confirmation'
SUBJECT_VALIDATE = '[TVB] Account validated'
SUBJECT_RECOVERY = '[TVB] Recover password'
TEXT_RECOVERY = 'A new password was generated for you. Please login with \
the below password and change it to one you can easily remember as soon as \
possible.\n Thank you.\n\n Password: %s'
TEXT_DISPLAY = "Thank you! Please check your email for further details!"
TEXT_CREATE = (',\n\nYour registration has been notified to the administrators '
               + 'of The Virtual Brain Project; you will receive an mail as ' 
               + 'soon as the administrator has validated your registration.'
               + ' \n\nThank you for registering!\nTVB Team')
TEXT_CREATE_TO_ADMIN = 'New member requires validation. Go to this url to validate '
TEXT_VALIDATED = ',\n\nYour registration has been validated by TVB Administrator, Please proceed with the login at '
KEY_USERNAME = "username"
KEY_PASSWORD = "password"
KEY_EMAIL = "email"
KEY_ROLE = "role"
KEY_COMMENT = "comment"
DEFAULT_PASS_LENGTH = 10
USERS_PAGE_SIZE = 7
FILE_UPGRADE_LOCK = threading.Lock()


<div class="viewcode-block" id="UserService"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService">[docs]</a>class UserService:
    """
    CRUD methods for USER entities are here.
    """
    USER_ROLES = model.USER_ROLES

    def __init__(self):
        self.logger = get_logger(self.__class__.__module__)
    
    
<div class="viewcode-block" id="UserService.create_user"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.create_user">[docs]</a>    def create_user(self, username=None, password=None, password2=None, 
                    role=None, email=None, comment=None, email_msg=None, validated=False):
        """
        Service Layer for creating a new user.
        """
        #Basic fields validation.
        if (username is None) or len(username) &lt; 1:
            raise UsernameException("Empty UserName!")
        if (password is None) or len(password) &lt; 1:
            raise UsernameException("Empty password!")
        if password2 is None:
            password2 = password
        if password != password2:
            raise UsernameException("Passwords do not match!")
        try:
            user_validated = (role == 'ADMINISTRATOR') or validated
            user = model.User(username, password, email, user_validated, role)
            if email_msg == None:
                email_msg = 'Hello ' + username + TEXT_CREATE
            admin_msg = (TEXT_CREATE_TO_ADMIN + username  + ' :\n '+ cfg.BASE_URL + 'user/validate/' + username +  
                         '\n\n"' + str(comment) + '"')
            self.logger.info("Registering user "+ username +" !")
            if role != 'ADMINISTRATOR' and email is not None:
                admins = UserService.get_administrators()
                admin = admins[randint(0, len(admins) - 1)]
                if (admin.email is not None 
                    and (admin.email != cfg.DEFAULT_ADMIN_EMAIL or cfg.SERVER_IP != cfg.LOCALHOST)):
                    #Do not send validation email in case default admin email 
                    # remained unchanged but TVB in locally deployed....
                    sendmail.send(FROM_ADDRESS, admin.email, SUBJECT_REGISTER, admin_msg)
                    self.logger.debug("Email sent to:" + admin.email + " for validating user:" + username +" !")
                sendmail.send(FROM_ADDRESS, email, SUBJECT_REGISTER, email_msg)
                self.logger.debug("Email sent to:"+ email + " for notifying new user:" + username +" !")
            user = dao.store_entity(user)
            if not SettingsService.is_first_run():
                eventhandler.handle_event(".".join([self.__class__.__name__, stack()[0][3]]), user)
            return TEXT_DISPLAY
        except Exception, excep:
            self.logger.error("Could not create user!")
            self.logger.exception(excep)
            raise UsernameException(excep.message)
        
        </div>
<div class="viewcode-block" id="UserService.reset_password"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.reset_password">[docs]</a>    def reset_password(self, **data):
        """
        Service Layer for reseting a password.
        """
        if (KEY_USERNAME not in data) or len(data[KEY_USERNAME]) &lt; 1:
            raise UsernameException("Empty UserName!")
        if (KEY_EMAIL not in data) or len(data[KEY_EMAIL]) &lt; 1:
            raise UsernameException("Empty Email!")
        try:
            old_pass = None
            user_name = data[KEY_USERNAME]
            email = data[KEY_EMAIL]
            user = dao.get_user_by_name_email(user_name, email)
            if user is None:
                raise UsernameException("Given credentials don't match!")
            old_pass = user.password
            new_pass = ''.join(chr(randint(48, 122)) for i in range(DEFAULT_PASS_LENGTH))
            user.password = md5(new_pass).hexdigest()
            self.edit_user(user, old_pass)            
            self.logger.info("Setting new password for user " + user_name +" !")
            sendmail.send(FROM_ADDRESS, email, SUBJECT_RECOVERY, TEXT_RECOVERY%(new_pass,))
            return TEXT_DISPLAY
        except Exception, excep:
            if old_pass and len(old_pass) &gt; 1:
                user.password = old_pass
                dao.store_entity(user)
            self.logger.error("Could not change user password!")
            self.logger.exception(excep)
            raise UsernameException(excep.message)
        
     </div>
    @staticmethod
<div class="viewcode-block" id="UserService.is_username_valid"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.is_username_valid">[docs]</a>    def is_username_valid(name):
        """
        Service layer for checking if a given UserName is unique or not.
        """
        users_no = dao.count_users_for_name(name)
        if  users_no &gt; 0:
            return False
        return True
    
    </div>
<div class="viewcode-block" id="UserService.validate_user"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.validate_user">[docs]</a>    def validate_user(self, name='', user_id=None):
        """
        Service layer for editing a user and validating the account.
        """
        try:
            if user_id:
                user = dao.get_user_by_id(user_id)
            else:
                user = dao.get_user_by_name(name)
            if user is None or user.validated:
                self.logger.warning("UserName not found or already validated:" + name)
                return False
            user.validated = True
            user = dao.store_entity(user)
            self.logger.debug("Sending validation email for userName="+ name +" to address="+ user.email)
            sendmail.send(FROM_ADDRESS, user.email, SUBJECT_VALIDATE, 'Hello ' 
                          + name + TEXT_VALIDATED + cfg.BASE_URL +"user/")
            self.logger.info("User:" + name + " was validated successfully" + " and notification email sent!")
            return True
        except Exception, excep:
            self.logger.warning('Could not validate user:')
            self.logger.warning('WARNING : '+str(excep))
            return False
        
     </div>
    @staticmethod   
<div class="viewcode-block" id="UserService.check_login"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.check_login">[docs]</a>    def check_login(username, password):
        """
        Service layer to check if given UserName and Password are according to DB.
        """
        user = dao.get_user_by_name(username)
        if (user is not None and user.password == md5(password).hexdigest() and user.validated):  
            return user
        else:  
            return None

</div>
<div class="viewcode-block" id="UserService.get_users_for_project"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.get_users_for_project">[docs]</a>    def get_users_for_project(self, user_name, project_id, page = 1):
        """
        Return tuple: (All Users except the project administrator, Project Members).
        Parameter "user_name" is the current user. 
        Parameter "user_name" is used for new projects (project_id is None). 
        When "project_id" not None, parameter "user_name" is ignored.       
        """
        try:
            admin_name = user_name
            if project_id is not None:
                project = dao.get_project_by_id(project_id)
                if (project is not None):
                    admin_name = project.administrator.username 
            all_users, total_pages = self.retrieve_all_users(admin_name, page)
            members = dao.get_members_of_project(project_id)
            return all_users, members, total_pages
        except Exception, excep:
            self.logger.error("Invalid userName or project identifier")
            self.logger.exception(excep)
            raise UsernameException(excep.message)
        
    </div>
    @staticmethod
<div class="viewcode-block" id="UserService.retrieve_all_users"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.retrieve_all_users">[docs]</a>    def retrieve_all_users(username, current_page = 1):
        """
        Return all users from the database except the given user
        """  
        start_idx = USERS_PAGE_SIZE * (current_page - 1)
        total = dao.get_all_users(username, is_count = True)
        end_idx = (USERS_PAGE_SIZE if total &gt;= start_idx+USERS_PAGE_SIZE else total-start_idx)
        user_list  = dao.get_all_users(username, start_idx, end_idx)
        pages_no = total//USERS_PAGE_SIZE + (1 if total %USERS_PAGE_SIZE else 0)
        return user_list, pages_no
    
    </div>
<div class="viewcode-block" id="UserService.edit_user"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.edit_user">[docs]</a>    def edit_user(self, edited_user, old_password=None):
        """
        Retrieve a user by and id, then modify it's role and validate status.
        """
        if edited_user.validated:
            self.validate_user(user_id=edited_user.id)
        user = dao.get_user_by_id(edited_user.id)
        user.role = edited_user.role
        user.validated = edited_user.validated
        if old_password is not None:
            if user.password == old_password:
                user.password = edited_user.password
            else:
                raise UsernameException("Invalid old password!")
        user.email = edited_user.email
        for key, value in edited_user.preferences.iteritems():
            user.preferences[key] = value
        dao.store_entity(user)
        if user.is_administrator():
            cfg.update_config_file({SettingsService.KEY_ADMIN_EMAIL: user.email,
                                    SettingsService.KEY_ADMIN_PWD: user.password})
        
    </div>
<div class="viewcode-block" id="UserService.delete_user"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.delete_user">[docs]</a>    def delete_user(self, user_id):
        """ 
        Delete a user with a given ID. 
        Return True when successfully, or False."""
        try:
            dao.delete_user(user_id)
            return True
        except Exception, excep:
            self.logger.exception(excep)
            return False
        
    </div>
    @staticmethod
<div class="viewcode-block" id="UserService.get_administrators"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.get_administrators">[docs]</a>    def get_administrators():
        """Retrieve system administrators.
        Will be used for sending emails, for example."""
        return dao.get_administrators()
        
    </div>
    @staticmethod  
<div class="viewcode-block" id="UserService.save_project_to_user"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.save_project_to_user">[docs]</a>    def save_project_to_user(user_id, project_id):
        """
        Mark for current user that the given project is the last one selected.
        """ 
        user = dao.get_user_by_id(user_id)
        user.selected_project = project_id
        dao.store_entity(user)

</div>
    @staticmethod
<div class="viewcode-block" id="UserService.get_user_by_id"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.get_user_by_id">[docs]</a>    def get_user_by_id(user_id):
        """
        Retrieves a user by its id.
        """
        return dao.get_user_by_id(user_id)
    </div>
    @synchronized(FILE_UPGRADE_LOCK)
<div class="viewcode-block" id="UserService.upgrade_file_storage"><a class="viewcode-back" href="../../../../tvb.core.services.html#tvb.core.services.userservice.UserService.upgrade_file_storage">[docs]</a>    def upgrade_file_storage(self):
        """
        For the given user upgrade all datatype files storage.
        
        @return: a two entry tuple (status, message) where status is a boolean that is True in case
            the upgrade was successfull for all datatypes and False otherwise, and message is a status
            update message.
        """
        status = None
        message = ''
        if cfg.DATA_CHECKED_TO_VERSION &lt; cfg.DATA_VERSION:
            self.logger.info("Starting to ugrade all datatype file storage.")
            status, message = FilesUpdateManager().upgrade_all_files_from_storage()
        return status, message
         
            </pre></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">The Virtual Brain 1.0.4 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>